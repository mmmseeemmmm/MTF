<uiHelpers:MTFUserControl x:Class="MTFApp.SequenceEditor.SequenceEditorControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mtfClientServerCommon="clr-namespace:MTFClientServerCommon;assembly=MTFClientServerCommon"
             xmlns:uiHelpers="clr-namespace:MTFApp.UIHelpers"
             xmlns:editors="clr-namespace:MTFApp.UIHelpers.Editors"             
             xmlns:converters="clr-namespace:MTFApp.UIHelpers.Converters" 
             xmlns:seqEditor="clr-namespace:MTFApp.SequenceEditor"             
             xmlns:s="clr-namespace:System;assembly=mscorlib"        
             xmlns:nullableComboBox="clr-namespace:MTFApp.UIControls.NullableComboBox"
             xmlns:activityTargetControl="clr-namespace:MTFApp.UIControls.ActivityTargetControl"
             xmlns:mtfTable="clr-namespace:MTFClientServerCommon.MTFTable;assembly=MTFClientServerCommon"
             xmlns:mtfValidationTable="clr-namespace:MTFClientServerCommon.MTFValidationTable;assembly=MTFClientServerCommon"
             xmlns:detailDataTemplates="clr-namespace:MTFApp.SequenceEditor.DetailDataTemplates"
             xmlns:multiSelectComboBox="clr-namespace:MTFApp.UIControls.MultiSelectComboBox"
             xmlns:alControls="clr-namespace:ALControls;assembly=ALControls"
             xmlns:localizedString="clr-namespace:MTFApp.UIHelpers.Editors.LocalizedString"
             xmlns:settings="clr-namespace:MTFApp.SequenceEditor.Settings"
             xmlns:graphicalView="clr-namespace:MTFApp.SequenceEditor.GraphicalView"
             xmlns:activityParametersControl="clr-namespace:MTFApp.UIControls.ActivityParametersControl"
             mc:Ignorable="d" 
             d:DesignHeight="300" d:DesignWidth="600">
    <UserControl.Resources>

        <Style TargetType="ToggleButton" BasedOn="{StaticResource EditorToogleButton}" />

        <Style TargetType="{x:Type GroupBox}" BasedOn="{StaticResource ActivityDetailGroupBox}" />

        <Style TargetType="alControls:TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}" />

        <Style TargetType="ComboBox" x:Key="rightPanelComboBox" BasedOn="{StaticResource {x:Type ComboBox}}">
            <Setter Property="Height" Value="{StaticResource ItemHeight}" />
            <Setter Property="Margin" Value="5 0 5 0" />
        </Style>
        <Style TargetType="TextBlock" x:Key="rightPanelTextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
            <Setter Property="Margin" Value="8 10 0 0" />
        </Style>
        <Style TargetType="TextBox" x:Key="rightPanelTextBox" BasedOn="{StaticResource {x:Type TextBox}}">
            <Setter Property="Height" Value="{StaticResource ItemHeight}" />
            <Setter Property="Margin" Value="5 0 5 0" />
        </Style>

        <DataTemplate x:Key="collapsedArrow">
            <UserControl Style="{StaticResource IconCollapsedArrow}" />
        </DataTemplate>
        <DataTemplate x:Key="expandedArrow">
            <UserControl Style="{StaticResource IconExpandedArrow}" />
        </DataTemplate>


        <uiHelpers:DataTemplateByTypeSelector x:Key="detailObjectInfoSelector" 
                                      DataTemplateNameSufix="DetailDataTemplate" />
        
        <converters:SubSequenceConditionVisibilityConverter x:Key="SubSequenceConditionVisibilityConverter" />
        
        <converters:EnumToVisibilityConverter x:Key="loggingTypeOpenLogFileConverter" VisibleEnumValue="OpenLogFile"/>
        <converters:EnumToVisibilityConverter x:Key="loggingTypeLogMessageConverter" VisibleEnumValue="LogMessage"/>
        <converters:StringToVisibilityConverter x:Key="negativeEmptyStringToVisibilityConverter" TrueValue="Visible" FalseValue="Collapsed" />
        <converters:MTFServiceCommandIconToStyle x:Key="serviceCommandIconConverter" />
        <converters:CompareTwoObjectsToVisibilityConverter x:Key="compareObjectsVisibilityConverter" />
        <converters:SubSequenceCasesVisibilityMultiConverter x:Key="CasesVisibilityMultiConverter" />

        <Style TargetType="{x:Type MenuItem}" BasedOn="{StaticResource {x:Type MenuItem}}" x:Key="ComponentMenuStyle">
            <Setter Property="Command"
                    Value="{Binding DataContext.AddClassToSequence, RelativeSource={RelativeSource FindAncestor,AncestorType={x:Type UserControl}}}" />
            <Setter Property="CommandParameter" Value="{Binding}" />
        </Style>

        <Style TargetType="{x:Type MenuItem}" BasedOn="{StaticResource {x:Type MenuItem}}" x:Key="SwitchComponentMenuStyle">
            <Setter Property="Command"
                    Value="{Binding DataContext.SwitchClassType, RelativeSource={RelativeSource FindAncestor,AncestorType={x:Type UserControl}}}" />
            <Setter Property="CommandParameter" Value="{Binding}" />
        </Style>

        <ContextMenu Grid.IsSharedSizeScope="True" x:Key="ComponentsContextMenu">
            <ContextMenu.Resources>

                <HierarchicalDataTemplate DataType="{x:Type mtfClientServerCommon:MTFClassCategory}"
                                          ItemsSource="{Binding Classes}">
                    <ContentPresenter Content="{Binding Name}" />
                </HierarchicalDataTemplate>
                <DataTemplate DataType="{x:Type mtfClientServerCommon:MTFClassInfo}">
                    <ContentControl>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition SharedSizeGroup="classInfoIcon" />
                                <ColumnDefinition />
                            </Grid.ColumnDefinitions>
                            <UserControl HorizontalAlignment="Right" VerticalAlignment="Top" MaxWidth="30"
                                         MaxHeight="30"
                                         Style="{Binding Icon, Converter={StaticResource IconConverter}}"
                                         Margin="0,5,10,0" />
                            <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" />
                        </Grid>
                    </ContentControl>
                </DataTemplate>
            </ContextMenu.Resources>
            <MenuItem Header="Add device" ItemsSource="{Binding ClassCategories}"
                      ItemContainerStyle="{StaticResource ComponentMenuStyle}" />
            <MenuItem Header="Remove device" Command="{Binding RemoveClassFromSequence}" />
            <MenuItem Header="Find usages" Command="{Binding CreateFindUsagesCommand}"
                      CommandParameter="{Binding PlacementTarget.SelectedItem, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ContextMenu}}}" />
            <MenuItem Header="Switch device type" ItemsSource="{Binding ClassCategories}"
                      ItemContainerStyle="{StaticResource SwitchComponentMenuStyle}" />
        </ContextMenu>

        <DataTemplate x:Key="EmptyTemplate" />

        <DataTemplate x:Key="componentsFromSequence">
            <ListBox
                Padding="0"
                BorderThickness="0"
                ScrollViewer.CanContentScroll="False"
                ItemsSource="{Binding Sequence.MTFSequenceClassInfos}"
                HorizontalContentAlignment="Stretch"
                PreviewMouseDown="MTFSequenceClassInfoListBox_PreviewMouseDown"
                PreviewMouseMove="MTFSequenceClassInfoListBox_PreviewMouseMove"
                ContextMenu="{StaticResource ComponentsContextMenu}"
                PreviewMouseLeftButtonUp="MTFSequenceClassInfoListBox_PreviewMouseLeftButtonUp"
                GotFocus="ListBox_GotFocus"
                KeyDown="MTFSequenceClassInfoListBox_KeyDown"
                ItemContainerStyle="{StaticResource NoSelectionListBoxItem}"
                Template="{StaticResource ListBoxControlTemplate}">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <Border Name="Bd" HorizontalAlignment="Stretch" Margin="0,0,0,3" Padding="0" BorderThickness="0"
                                    AllowDrop="True" Drop="Component_Drop" Tag="{Binding}"
                                    PreviewDragOver="Component_DragOver">
                                <Grid Grid.Row="0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" SharedSizeGroup="componentIcon" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <UserControl Grid.Column="0" Margin="2">
                                        <UserControl Style="{Binding MTFClass.Icon, Converter={StaticResource IconConverter}}" />
                                        <UserControl.Style>
                                            <Style TargetType="UserControl">
                                                <Setter Property="Foreground" Value="{StaticResource ALBlackBrush}" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsEnabled}" Value="False">
                                                        <Setter Property="Foreground" Value="{StaticResource ALDarkYellowBrush}" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </UserControl.Style>
                                    </UserControl>

                                    <TextBlock Grid.Column="1"
                                                Text="{Binding Alias}" VerticalAlignment="Center" HorizontalAlignment="Left"
                                                Margin="5,0,0,0">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
                                                <Setter Property="Foreground" Value="{StaticResource ALBlackBrush}" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsEnabled}" Value="False">
                                                        <Setter Property="Foreground" Value="{StaticResource ALDarkYellowBrush}" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Bottom">
                                        <UserControl Visibility="{Binding MTFClass.IsStatic, Converter={StaticResource NotBoolToVisibility}}">
                                            <UserControl Style="{StaticResource IconLink}" Width="15" Margin="0 0 5 5" 
                                                     Foreground="{StaticResource ALLightRedBrush}" 
                                                     Visibility="{Binding MTFClassInstanceConfiguration, Converter={StaticResource NullToVisibility}}"/>
                                        </UserControl>
                                        <UserControl Style="{StaticResource IconDatabase}" Width="15" Margin="0 0 5 5" 
                                                 Foreground="{StaticResource ALBlackBrush}" 
                                                 Visibility="{Binding Data, Converter={StaticResource NotNullToVisibility}}"/>
                                    </StackPanel>
                                </Grid>
                                <Border.Style>
                                    <Style TargetType="Border" BasedOn="{StaticResource EditorLeftPanelItemBorder}">
                                        <Setter Property="Background" Value="{StaticResource ALLightSilverBrush}" />
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{StaticResource ALGrayBrush}" />
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                            </Border>
                            <ListBox ItemsSource="{Binding SubComponents}" Grid.Row="1" Margin="15,0,0,0" HorizontalContentAlignment="Stretch"
                                     Name="SubComponentsListBox"
                                     PreviewMouseDown="MTFSequenceClassInfoListBox_PreviewMouseDown"
                                     ItemContainerStyle="{StaticResource NoSelectionListBoxItem}"
                                     GotFocus="ListBox_GotFocus"
                                     PreviewMouseWheel="ScrollParentListBox">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border Name="Bd" HorizontalAlignment="Stretch" Margin="0,0,0,3" Padding="0" BorderThickness="0">
                                            <StackPanel Orientation="Horizontal" Grid.Column="0" VerticalAlignment="Center" HorizontalAlignment="Left"
                                                            TextBlock.Foreground="{StaticResource ALBlackBrush}">
                                                <TextBlock Text="{Binding Parent.Name}" Margin="5,0,0,0" FontStyle="Italic" />
                                                <TextBlock Text="{Binding Alias, StringFormat=': {0}'}"/>
                                            </StackPanel>
                                            <Border.Style>
                                                <Style TargetType="Border" BasedOn="{StaticResource EditorLeftPanelItemBorder}">
                                                    <Setter Property="Background" Value="{StaticResource ALLightSilverBrush}" />
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="{StaticResource ALGrayBrush}" />
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </DataTemplate>
        <DataTemplate x:Key="componentsFromSubSequences">
            <Grid Name="ComponentsGridIncludingSubsequenceComponents" Loaded="GridOnLoaded">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="200" />
                </Grid.RowDefinitions>
                <ContentPresenter Content="{Binding}" Grid.Row="0" ContentTemplate="{StaticResource componentsFromSequence}" />
                <Grid Grid.Row="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <Border Grid.Row="0" Background="{StaticResource ALYellowBrush}" Height="30"
                                Margin="-3,-3,-6,0">
                        <TextBlock Text="Components from SubSequences" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="5" />
                    </Border>
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                        <ListBox ItemsSource="{Binding SubSequenceComponents}"
                                 AllowDrop="True"
                                 PreviewDragOver="SubComponentsListBox_DragOver"
                                 Drop="SubComponentsListBox_Drop"
                                 Name="SubComponentsListBox"
                                 PreviewMouseDown="MTFSequenceClassInfoListBox_PreviewMouseDown"
                                 PreviewMouseMove="MTFSequenceClassInfoListBox_PreviewMouseMove"
                                     ItemContainerStyle="{StaticResource NoSelectionListBoxItem}"
                                 GotFocus="ListBox_GotFocus"
                                     Template="{StaticResource ListBoxControlTemplate}"
                                     HorizontalContentAlignment="Stretch"
                                     PreviewMouseWheel="ScrollParentListBox">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border Name="Bd" HorizontalAlignment="Stretch" Margin="0,0,0,3" Padding="0" BorderThickness="0">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" SharedSizeGroup="componentIcon" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>
                                            <UserControl Grid.Column="0"
                                                Style="{Binding MTFClass.Icon, Converter={StaticResource IconConverter}}"
                                                Foreground="{StaticResource ALBlackBrush}"
                                                Margin="2"/>
                                            <StackPanel Orientation="Horizontal" Grid.Column="1" VerticalAlignment="Center" HorizontalAlignment="Left"
                                                            TextBlock.Foreground="{StaticResource ALBlackBrush}">
                                                <TextBlock Text="{Binding Parent.Name}" Margin="5,0,0,0" FontStyle="Italic" />
                                                <TextBlock Text=": " />
                                                <TextBlock Text="{Binding Alias}"/>
                                            </StackPanel>
                                        </Grid>
                                        <Border.Style>
                                            <Style TargetType="Border" BasedOn="{StaticResource EditorLeftPanelItemBorder}">
                                                <Setter Property="Background" Value="{StaticResource ALLightSilverBrush}" />
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="{StaticResource ALGrayBrush}" />
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                </Grid>
                <GridSplitter Grid.Row="1" Style="{StaticResource HorizontalGridSplitter}" DragCompleted="GridSplitterDragCompleted"/>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="componentsTemplate">
            <Grid Margin="0,1,0,0" DataContext="{Binding DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"
                   FocusVisualStyle="{x:Null}">
                <Grid.RowDefinitions>
                    <!--<RowDefinition Height="Auto" />-->
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <Border Grid.Row="0" Style="{StaticResource EditorLeftPanelItemBorder}" Background="White">
                    <Button Click="AddButtonInLeftPanel_Click" Margin="0" Content="+"
                                        BorderThickness="0">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                <Setter Property="Background" Value="{StaticResource ALBlackBrush}" />
                                <Setter Property="Foreground" Value="{StaticResource ALWhiteBrush}" />
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{StaticResource ALYellowBrush}" />
                                        <Setter Property="Foreground" Value="{StaticResource ALBlackBrush}" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                        <Button.ContextMenu>
                            <ContextMenu ItemsSource="{Binding ClassCategories}" ItemContainerStyle="{StaticResource ComponentMenuStyle}">
                                <ContextMenu.Resources>
                                    <HierarchicalDataTemplate DataType="{x:Type mtfClientServerCommon:MTFClassCategory}"
                                                              ItemsSource="{Binding Classes}">
                                        <ContentPresenter Content="{Binding Name}" />
                                    </HierarchicalDataTemplate>
                                    <DataTemplate DataType="{x:Type mtfClientServerCommon:MTFClassInfo}">
                                        <ContentControl>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition SharedSizeGroup="classInfoIcon"/>
                                                    <ColumnDefinition/>
                                                </Grid.ColumnDefinitions>
                                                <UserControl HorizontalAlignment="Right" VerticalAlignment="Top" MaxWidth="30" MaxHeight="30"
                                            Style="{Binding Icon, Converter={StaticResource IconConverter}}"
                                            Margin="0,5,10,0"/>
                                                <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" />
                                            </Grid>
                                        </ContentControl>
                                    </DataTemplate>
                                </ContextMenu.Resources>
                            </ContextMenu>
                        </Button.ContextMenu>
                    </Button>
                </Border>

                <Border Grid.Row="1" Style="{StaticResource EditorLeftPanelItemBorder}" Background="White">
                    <Border BorderThickness="1" BorderBrush="{StaticResource ResourceKey=ElementBorderBrush}" Margin="3">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto" />
                                <ColumnDefinition />
                                <ColumnDefinition Width="auto" />
                            </Grid.ColumnDefinitions>
                            <UserControl Style="{StaticResource IconSearch}" Foreground="Black" Margin="3 3 0 3"/>
                            <TextBox Grid.Column="1" MinWidth="0" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="5 0 5 0" Foreground="Black" BorderBrush="White"  VerticalAlignment="Center" />
                            <Button Grid.Column="2" Style="{StaticResource RemoveButton}" Margin="0 0 5 0" Command="{Binding CleanSearchText}" />
                        </Grid>
                    </Border>
                </Border>

                <ListBox
                    Visibility="{Binding SearchText, Converter={StaticResource EmptyStringToCollapsedVisibilityConverter}}"
                    Grid.Row="3" VerticalAlignment="Stretch"
                    Padding="0" 
                    ItemsSource="{Binding SearchResults}" 
                    Grid.IsSharedSizeScope="True"
                    BorderThickness="0"
                    HorizontalContentAlignment="Stretch"
                    PreviewMouseMove="MTFSequenceClassInfoListBox_PreviewMouseMove"
                    PreviewMouseDown="MTFSequenceClassInfoListBox_PreviewMouseDown"
                    PreviewMouseLeftButtonUp="MTFSequenceClassInfoListBox_PreviewMouseLeftButtonUp"
                    KeyDown="MTFSequenceClassInfoListBox_KeyDown"
                    ItemContainerStyle="{StaticResource NoSelectionListBoxItem}"
                    Template="{StaticResource ListBoxControlTemplate}"
                    ScrollViewer.CanContentScroll="False"
                    FocusVisualStyle="{x:Null}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border HorizontalAlignment="Stretch" Margin="0,0,0,3" Padding="0" BorderThickness="0" >
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="{StaticResource ALLightSilverBrush}" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsClassNOTInSequence}" Value="True">
                                                <Setter Property="Background" Value="{StaticResource ALYellowBrush}" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" SharedSizeGroup="componentIcon" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <UserControl Grid.Column="0" Grid.RowSpan="2"
                                                 Height="26"
                                                 Style="{Binding ClassInfo.Icon, Converter={StaticResource IconConverter}}"
                                                 Foreground="{StaticResource ALBlackBrush}"
                                                 Margin="2"/>
                                    <TextBlock Grid.Column="1"
                                               Text="{Binding ClassInfo.Name}" VerticalAlignment="Center" HorizontalAlignment="Left"
                                               Foreground="{StaticResource ALBlackBrush}"
                                               Margin="5,0,0,0"/>
                                    <TextBlock Grid.Column="1" Grid.Row="1"
                                               Text="{Binding Alias}" VerticalAlignment="Center" HorizontalAlignment="Left"
                                               Foreground="{StaticResource ALBlackBrush}"
                                               Margin="5,0,0,0"/>
                                    <ListBox Grid.Row="2" Grid.ColumnSpan="2" ItemsSource="{Binding Methods}" Margin="20 5 0 5"
                                             Background="{Binding Background, RelativeSource={RelativeSource AncestorType=Border}}"
                                             ItemContainerStyle="{StaticResource NoSelectionListBoxItem}"
                                             PreviewMouseWheel="ScrollParentListBox"
                                             ScrollViewer.CanContentScroll="False"
                                             PreviewMouseMove="MTFSequenceClassInfoListBox_PreviewMouseMove"
                                             PreviewMouseDown="MTFSequenceClassInfoListBox_PreviewMouseDown"
                                             PreviewMouseLeftButtonUp="MTFSequenceClassInfoListBox_PreviewMouseLeftButtonUp"
                                             KeyDown="MTFSequenceClassInfoListBox_KeyDown">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding DisplayName}" ToolTip="{Binding Description}" />
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                <Grid Grid.Row="3" VerticalAlignment="Stretch" Grid.IsSharedSizeScope="True"
                      Visibility="{Binding SearchText, Converter={StaticResource negativeEmptyStringToVisibilityConverter}}">
                    <ContentPresenter Content="{Binding}" Visibility="{Binding DisplaySubComponents, Converter={StaticResource NotBoolToVisibility}}"
                                      ContentTemplate="{StaticResource componentsFromSequence}" />
                    <ContentPresenter Content="{Binding}" Visibility="{Binding DisplaySubComponents, Converter={StaticResource BoolToVisibility}}"
                                      ContentTemplate="{StaticResource componentsFromSubSequences}" />

                </Grid>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="variablesTemplate">
            <Grid Margin="0,1,0,0" DataContext="{Binding DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <Border Grid.Row="0" Style="{StaticResource EditorLeftPanelItemBorder}">

                    <Button Click="AddButtonInLeftPanel_Click" Margin="0" Content="+"
                                        BorderThickness="0">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                <Setter Property="Background" Value="{StaticResource ALBlackBrush}" />
                                <Setter Property="Foreground" Value="{StaticResource ALWhiteBrush}" />
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{StaticResource ALYellowBrush}" />
                                        <Setter Property="Foreground" Value="{StaticResource ALBlackBrush}" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                        <Button.ContextMenu>
                            <ContextMenu ItemsSource="{Binding VariableCategories}" DisplayMemberPath="Name">
                                <ContextMenu.Resources>
                                    <Style TargetType="{x:Type MenuItem}" BasedOn="{StaticResource {x:Type MenuItem}}">
                                        <Setter Property="Command" 
                                                            Value="{Binding DataContext.AddVariableToSequence, RelativeSource={RelativeSource FindAncestor,AncestorType={x:Type UserControl}}}" />
                                        <Setter Property="CommandParameter" Value="{Binding}" />
                                    </Style>

                                    <HierarchicalDataTemplate DataType="{x:Type mtfClientServerCommon:MTFClassCategory}" ItemsSource="{Binding Classes}">
                                        <ContentPresenter Content="{Binding Name}" />
                                    </HierarchicalDataTemplate>
                                    <DataTemplate DataType="{x:Type mtfClientServerCommon:MTFClassInfo}">
                                        <ContentPresenter Content="{Binding Name}" />
                                    </DataTemplate>
                                </ContextMenu.Resources>
                            </ContextMenu>
                        </Button.ContextMenu>
                    </Button>
                </Border>
                <ListBox 
                                         Grid.Row="1" Grid.IsSharedSizeScope="True" VerticalAlignment="Stretch"
                                         Padding="0"
                                         BorderThickness="0"
                                         ItemsSource="{Binding Sequence.MTFVariables}" 
                                         HorizontalContentAlignment="Stretch"
                                         PreviewMouseMove="VariableListBox_PreviewMouseMove"
                                         PreviewMouseLeftButtonDown="VariableListBox_PreviewMouseLeftButtonDown"
                                         PreviewMouseLeftButtonUp="VariableListBox_PreviewMouseLeftButtonUp"
                                         PreviewMouseRightButtonDown="VariableListBox_PreviewMouseRightButtonDown"
                                         GotFocus="ListBox_GotFocus"
                                         SelectedItem="{Binding SelectedVariable}"
                                         KeyDown="VariableListBox_KeyDown"
                                         ItemContainerStyle="{StaticResource NoSelectionListBoxItem}"
                                         Template="{StaticResource ListBoxControlTemplate}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border HorizontalAlignment="Stretch" Margin="0,0,0,3" Padding="0" BorderThickness="0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="30" />
                                    </Grid.RowDefinitions>
                                    <UserControl Grid.Column="0" Grid.RowSpan="2" MaxWidth="25"
                                                Style="{Binding TypeName, Converter={StaticResource TypeToIconConverter}}"
                                                Foreground="{StaticResource ALBlackBrush}"
                                                Margin="2 6 2 6"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" HorizontalAlignment="Left"
                                                       Foreground="{StaticResource ALBlackBrush}"
                                                       Margin="10,0,0,0"/>
                                    <UserControl Style="{StaticResource IconGlobal}" Foreground="{StaticResource ALBlackBrush}"
                                                 Visibility="{Binding IsGlobal, Converter={StaticResource BoolToVisibility}}"
                                                 Height="15" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="2,2,-8,2"
                                                 Background="Red"/>
                                </Grid>
                                <Border.Style>
                                    <Style TargetType="Border" BasedOn="{StaticResource EditorLeftPanelItemBorder}">
                                        <Setter Property="Background" Value="{StaticResource ALSilverBrush}" />
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{StaticResource ALGrayBrush}" />
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                    <ListBox.ContextMenu>
                        <ContextMenu>
                            <ContextMenu.Resources>
                                <Style TargetType="{x:Type MenuItem}" BasedOn="{StaticResource {x:Type MenuItem}}">
                                    <Setter Property="Command" 
                                                            Value="{Binding DataContext.AddVariableToSequence, RelativeSource={RelativeSource FindAncestor,AncestorType={x:Type UserControl}}}" />
                                    <Setter Property="CommandParameter" Value="{Binding}" />
                                </Style>
                            </ContextMenu.Resources>
                            <MenuItem Header="Add variable" ItemsSource="{Binding VariableCategories}" DisplayMemberPath="Name" />
                            <MenuItem Header="Copy" Command="{Binding CopyVariableCommand}" />
                            <MenuItem Header="Paste" Command="{Binding PasteVariableCommand}" />
                            <MenuItem Header="Remove variable" Command="{Binding RemoveVariableFromSequence}" />
                            <MenuItem Header="Find usages" Command="{Binding CreateFindUsagesCommand}" CommandParameter="{Binding PlacementTarget.SelectedItem, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ContextMenu}}}"/>
                        </ContextMenu>
                    </ListBox.ContextMenu>
                </ListBox>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="serviceCommandsTemplate">
            <Grid Margin="0,1,0,0" DataContext="{Binding DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <Border Grid.Row="0" Style="{StaticResource EditorLeftPanelItemBorder}">
                    <Button Margin="0" Content="+" BorderThickness="0" Command="{Binding AddServiceCommandCommand}">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                <Setter Property="Background" Value="{StaticResource ALBlackBrush}" />
                                <Setter Property="Foreground" Value="{StaticResource ALWhiteBrush}" />
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{StaticResource ALYellowBrush}" />
                                        <Setter Property="Foreground" Value="{StaticResource ALBlackBrush}" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </Border>
                <ListBox 
                        Grid.Row="1" Grid.IsSharedSizeScope="True" VerticalAlignment="Stretch"
                        Padding="0"
                        BorderThickness="0"
                        ItemsSource="{Binding Sequence.ServiceCommands}" 
                        PreviewMouseLeftButtonDown="ServiceCommandsListBox_PreviewMouseLeftButtonDown"
                        KeyDown="CommandListBox_OnKeyDown"
                        HorizontalContentAlignment="Stretch"
                        SelectedItem="{Binding SelectedServiceCommand}"
                        ItemContainerStyle="{StaticResource NoSelectionListBoxItem}"
                        Template="{StaticResource ListBoxControlTemplate}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border HorizontalAlignment="Stretch" Margin="0,0,0,3" Padding="0" BorderThickness="0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" SharedSizeGroup="serviceCommandIcon" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="30" />
                                    </Grid.RowDefinitions>
                                    <UserControl Grid.Column="0" Grid.RowSpan="2" MaxWidth="25"
                                                Style="{Binding Icon, Converter={StaticResource serviceCommandIconConverter}}"
                                                Foreground="{StaticResource ALBlackBrush}"
                                                Margin="2 6 2 6"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" HorizontalAlignment="Left"
                                                       Foreground="{StaticResource ALBlackBrush}"
                                                       Margin="10,0,0,0"/>
                                </Grid>
                                <Border.Style>
                                    <Style TargetType="Border" BasedOn="{StaticResource EditorLeftPanelItemBorder}">
                                        <Setter Property="Background" Value="{StaticResource ALSilverBrush}" />
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{StaticResource ALGrayBrush}" />
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                    <ListBox.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Remove command" Command="{Binding RemoveServiceCommandFromSequenceCommand}" />
                        </ContextMenu>
                    </ListBox.ContextMenu>
                </ListBox>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="userCommandsTemplate">
            <Grid Margin="0,1,0,0" DataContext="{Binding DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <Border Grid.Row="0" Style="{StaticResource EditorLeftPanelItemBorder}">
                    <Button Margin="0" Content="+" BorderThickness="0" Command="{Binding AddUserCommandCommand}">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                <Setter Property="Background" Value="{StaticResource ALBlackBrush}" />
                                <Setter Property="Foreground" Value="{StaticResource ALWhiteBrush}" />
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{StaticResource ALYellowBrush}" />
                                        <Setter Property="Foreground" Value="{StaticResource ALBlackBrush}" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </Border>
                <ListBox 
                        Grid.Row="1" Grid.IsSharedSizeScope="True" VerticalAlignment="Stretch"
                        Padding="0"
                        BorderThickness="0"
                        ItemsSource="{Binding Sequence.UserCommands}" 
                        PreviewMouseLeftButtonDown="UserCommandsListBox_PreviewMouseLeftButtonDown"
                        KeyDown="UserListBox_OnKeyDown"
                        HorizontalContentAlignment="Stretch"
                        SelectedItem="{Binding SelectedUserCommand}"
                        ItemContainerStyle="{StaticResource NoSelectionListBoxItem}"
                        Template="{StaticResource ListBoxControlTemplate}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border HorizontalAlignment="Stretch" Margin="0,0,0,3" Padding="0" BorderThickness="0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" SharedSizeGroup="serviceCommandIcon" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="30" />
                                    </Grid.RowDefinitions>
                                    <UserControl Grid.Column="0" Grid.RowSpan="2" MaxWidth="25"
                                                Style="{Binding Icon, Converter={StaticResource serviceCommandIconConverter}}"
                                                Foreground="{StaticResource ALBlackBrush}"
                                                Margin="2 6 2 6"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" HorizontalAlignment="Left"
                                                       Foreground="{StaticResource ALBlackBrush}"
                                                       Margin="10,0,0,0"/>
                                </Grid>
                                <Border.Style>
                                    <Style TargetType="Border" BasedOn="{StaticResource EditorLeftPanelItemBorder}">
                                        <Setter Property="Background" Value="{StaticResource ALSilverBrush}" />
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{StaticResource ALGrayBrush}" />
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                    <ListBox.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Remove command" Command="{Binding RemoveUserCommandFromSequenceCommand}" />
                        </ContextMenu>
                    </ListBox.ContextMenu>
                </ListBox>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="RowVersionDetail">
            <DataTemplate.Resources>
                <DataTemplate DataType="{x:Type mtfTable:MTFTableRow}">
                    <editors:MTFDataTableEditor Value="{Binding Mode=OneWay}" EditorMode="VariantRows"
                            ParentSequence="{Binding DataContext.Sequence, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}" />
                </DataTemplate>
                <DataTemplate DataType="{x:Type mtfValidationTable:MTFValidationTableRow}">
                    <editors:MTFValidationTableEditor Value="{Binding Mode=OneWay}" EditorMode="VariantRows"
                                              ParentSequence="{Binding DataContext.Sequence, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"/>
                </DataTemplate>
            </DataTemplate.Resources>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid Grid.Row="0" Visibility="{Binding Value.AllowNokGsForTable, Converter={StaticResource NotBoolToVisibility}, UpdateSourceTrigger=PropertyChanged}" Margin="0,3,5,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0" DataContext="{Binding DataContext.SelectedInitRow, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" SharedSizeGroup="title" />
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Allow NOK GS for selected row: " FontWeight="Bold" />
                        <CheckBox Grid.Column="1" IsChecked="{Binding AllowNokGs}" />
                    </Grid>

                    <Grid Grid.Row="1" Visibility="{Binding AllowNokGs, Converter={StaticResource BoolToVisibility}}" 
                          DataContext="{Binding DataContext.SelectedInitRow, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Border Grid.ColumnSpan="4" Background="{StaticResource ALYellowBrush}" Margin="0,10,0,5">
                            <TextBlock Text="NOK GS" HorizontalAlignment="Center" Margin="10"/>
                        </Border>
                        <editors:MTFVariantEditor Grid.Row="1" Grid.Column="0" Grid.RowSpan="2"
                                              Value="{Binding NokVariantSelector}"
                                              IsEnabled="true"
                                              ParentSequence="{Binding DataContext.Sequence, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"/>
                    </Grid>
                </Grid>
                <Grid Grid.Row="1" DataContext="{Binding DataContext.SelectedInitRow, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Border Background="{StaticResource ALYellowBrush}" Grid.Row="0" Margin="0,10,0,5" >
                        <TextBlock Text="{Binding VariantHeader}"
                                   HorizontalAlignment="Center" Margin="10"/>
                    </Border>
                    <ContentPresenter Content="{Binding}" Grid.Row="1" />
                </Grid>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="MTFSequenceClassInfoDetailDataTemplate">
            <detailDataTemplates:MTFSequenceClassInfo DataContext="{Binding}" />
        </DataTemplate>

        <DataTemplate x:Key="MTFSequenceActivityDetailDataTemplate">
            <ContentControl>
                <Grid>
                    <Grid.Resources>
                        <Style TargetType="GroupBox" BasedOn="{StaticResource {x:Type GroupBox}}">
                            <Setter Property="BorderThickness" Value="0" />
                            <Setter Property="Padding" Value="3" />
                        </Style>
                        <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                            <Setter Property="Margin" Value="0" />
                        </Style>
                    </Grid.Resources>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <StackPanel Grid.Row="0" Orientation="Vertical">
                        <Border Background="{StaticResource ALYellowBrush}"
                            Height="{StaticResource ItemHeight}">
                            <Grid>
                                <TextBlock Text="Activity Detail" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0"/>
                                <UserControl Style="{StaticResource IconTune}" Height="15" Margin="0 0 10 0" Visibility="{Binding SetupModeSupport, Converter={StaticResource BoolToVisibility}}" HorizontalAlignment="Right" VerticalAlignment="Center" />
                            </Grid>
                        </Border>
                        <TextBlock Text="{Binding MTFMethodDescription}" FontSize="10" TextWrapping="Wrap" 
                                   Margin="-20,10,0,0" Padding="30,0,10,0"
                                   MinWidth="300" HorizontalAlignment="Left"
                                   Visibility="{Binding MTFMethodDescription, Converter={StaticResource EmptyStringToCollapsedVisibilityConverter}}"
                                   Width="{Binding ActualWidth, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=ScrollContentPresenter}}" />
                    </StackPanel>

                    <GroupBox Grid.Row="1" Header="Function parameters:" Visibility="{Binding MTFParameters, IsAsync=True, Converter={StaticResource NotNullToVisibility}}">
                        <StackPanel Orientation="Vertical">
                            <activityParametersControl:ActivityParametersControl
                                ActivityParameters="{Binding MTFParameters}"
                                SelectedTerm="{Binding DataContext.SelectedTerm, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"/>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Grid.Row="2" Header="Output type:"
                              Visibility="{Binding ReturnType, Converter={StaticResource NotNullToVisibility}}">
                        <StackPanel Orientation="Vertical">
                            <TextBlock Text="{Binding ReturnType, Converter={StaticResource TypeNameConverter}}" />
                            <uiHelpers:ComplexTypeViewer TypeName="{Binding ReturnType}" Margin="5,0,0,0" />
                        </StackPanel>
                    </GroupBox>

                    <ContentPresenter Grid.Row="3" Content="{Binding}" ContentTemplate="{StaticResource CheckOutputValue}" />

                    <GroupBox Header="On output value failed" Grid.Row="4"
                              Visibility="{Binding ReturnType, Converter={StaticResource TypeToVisibility}}">
                        <StackPanel Orientation="Vertical">
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <CheckBox IsChecked="{Binding RepeatOnCheckOutputFailed}" />
                                <TextBlock Text=" Repeat" />
                            </StackPanel>
                            <StackPanel Orientation="Vertical">
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding RepeatOnCheckOutputFailed}" Value="True">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>
                                <Grid Margin="0,0,0,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Column="0" Grid.Row="0" Text="Number of repetitions: " VerticalAlignment="Center" />
                                    <uiHelpers:MTFEditor Grid.Column="1" Grid.Row="0" 
                                                         Value="{Binding NumberOfAttemptsOnCheckOutputFailed}"
                                                         TypeName="{Binding NumberTypeName}"
                                                         Margin="2"/>
                                    <TextBlock Grid.Column="0" Grid.Row="1"  Text="Delay between tries[ms]: " VerticalAlignment="Center" />
                                    <uiHelpers:MTFEditor Grid.Column="1" Grid.Row="1" 
                                                         Value="{Binding RepeatDelayOnCheckOutputFailed}"
                                                         TypeName="{Binding NumberTypeName}"
                                                         Margin="2"/>
                                </Grid>
                            </StackPanel>
                            <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource OnOutputValueFailedCombo}" />
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Grid.Row="5" Header="Assign output value"
                              Visibility="{Binding ReturnType, Converter={StaticResource TypeToVisibility}}">
                        <!--ItemsSource="{Binding DataContext.Sequence.MTFVariables, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type UserControl}}}"-->
                        <nullableComboBox:NullableComboBox
                            DisplayMemberPath="Name"
                            SelectedValue="{Binding Variable, UpdateSourceTrigger=Explicit}">
                            <nullableComboBox:NullableComboBox.ItemsSource>
                                <MultiBinding Converter="{StaticResource VariableByTypeConverter}">
                                    <Binding Path="ReturnType" />
                                    <Binding Path="DataContext.Sequence.MTFVariables"
                                             RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}" />
                                </MultiBinding>
                            </nullableComboBox:NullableComboBox.ItemsSource>
                        </nullableComboBox:NullableComboBox>
                    </GroupBox>

                    <GroupBox Grid.Row="6" Header="On Error:">
                        <StackPanel Orientation="Vertical">
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <CheckBox IsChecked="{Binding Repeat}" />
                                <TextBlock Text=" Repeat" />
                            </StackPanel>
                            <StackPanel Orientation="Vertical">
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Repeat}" Value="True">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>
                                <Grid Margin="0,0,0,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Column="0" Grid.Row="0" Text="Number of repetitions: " VerticalAlignment="Center" />
                                    <uiHelpers:MTFEditor Grid.Column="1" Grid.Row="0" 
                                                         Value="{Binding NumberOfAttempts}"
                                                         TypeName="{Binding NumberTypeName}"
                                                         Margin="2"/>
                                    <TextBlock Grid.Column="0" Grid.Row="1" Text="Delay between tries[ms]: " VerticalAlignment="Center" />
                                    <uiHelpers:MTFEditor Grid.Column="1" Grid.Row="1" 
                                                         Value="{Binding RepeatDelay}"
                                                         TypeName="{Binding NumberTypeName}"
                                                         Margin="2"/>
                                </Grid>

                            </StackPanel>
                            <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource OnErrorFailedCombo}" />
                            <!--<StackPanel Orientation="Horizontal">-->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Append error: " Grid.Column="0" VerticalAlignment="Center" />
                                <nullableComboBox:NullableComboBox Grid.Column="1" MinWidth="50" Margin="2,2,0,0"
                                                                   DisplayMemberPath="Name"
                                                                   SelectedValue="{Binding ErrorOutput, UpdateSourceTrigger=Explicit}">
                                    <nullableComboBox:NullableComboBox.ItemsSource>
                                        <MultiBinding Converter="{StaticResource VariableByTypeConverter}">
                                            <Binding Path="DataContext.Sequence.MTFVariables"
                                                     RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}" />
                                        </MultiBinding>
                                    </nullableComboBox:NullableComboBox.ItemsSource>
                                </nullableComboBox:NullableComboBox>
                            </Grid>
                            <!--</StackPanel>-->
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Grid.Row="7" Header="Behavior:">
                        <StackPanel Orientation="Vertical" >
                            <!--<StackPanel Grid.Row="4" Orientation="Horizontal">
                                <CheckBox IsChecked="{Binding WriteToLog}" />
                                <TextBlock Text=" Write to log" />
                            </StackPanel>-->
                            <StackPanel Orientation="Horizontal">
                                <CheckBox IsChecked="{Binding RunOnce}" />
                                <TextBlock Text=" Run Once" />
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>
                    <GroupBox Grid.Row="9" Header="Comment:" BorderThickness="0">
                        <TextBox Text="{Binding Comment, UpdateSourceTrigger=PropertyChanged}" TextWrapping="Wrap" MinHeight="100"
                                 VerticalContentAlignment="Top"  AcceptsReturn="True"/>
                    </GroupBox>

                </Grid>
            </ContentControl>
        </DataTemplate>

        <DataTemplate x:Key="ShowServiceProperty">
            <StackPanel>
                <TextBlock Text="After service finished" />
                <ComboBox ItemsSource="{Binding DataContext.ServiceExecutionBehaviors, RelativeSource={RelativeSource FindAncestor,AncestorType={x:Type UserControl}}}"
                          SelectedValuePath="Value" DisplayMemberPath="Description" 
                          SelectedValue="{Binding ServiceExecutionBehavior}" />
                <Grid Margin="0,4,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <TextBlock Text="Prepare service activity" VerticalAlignment="Top" Margin="0 4 4 0" Grid.Column="0" Grid.Row="0" />
                    <activityTargetControl:ActivityTarget Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="1" 
                                                          Activity="{Binding PrepaireServiceActivity}"
                                                          ActivitiesByCall="{Binding DataContext.Sequence.ActivitiesByCall, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"
                                                          IsComboBoxVisible="True"/>
                </Grid>
                <Grid Margin="0,4,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <TextBlock Text="Cleanup service activity" VerticalAlignment="Top" Margin="0 4 4 0" Grid.Column="0" Grid.Row="0"/>
                    <activityTargetControl:ActivityTarget Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="1" 
                                                          Activity="{Binding CleanupServiceActivity}" 
                                                          ActivitiesByCall="{Binding DataContext.Sequence.ActivitiesByCall, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"
                                                          IsComboBoxVisible="True"/>
                </Grid>
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="MTFSubSequenceActivityDetailDataTemplate">
            <ContentControl>
                <Grid>
                    <Grid.Resources>
                        <Style TargetType="GroupBox" BasedOn="{StaticResource {x:Type GroupBox}}">
                            <Setter Property="BorderThickness" Value="0" />
                            <Setter Property="Padding" Value="3" />
                        </Style>
                        <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                            <Setter Property="Margin" Value="0" />
                        </Style>
                    </Grid.Resources>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <Border Grid.Row="0" Background="{StaticResource ALYellowBrush}"
                            Height="{StaticResource ItemHeight}">
                        <TextBlock Text="SubSequence Detail" HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Margin="0"/>
                    </Border>
                    <GroupBox Grid.Row="1" Margin="0">
                        <GroupBox.Style>
                            <Style TargetType="GroupBox" BasedOn="{StaticResource {x:Type GroupBox}}">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ExecutionType}" Value="ExecuteByCase">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </GroupBox.Style>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <CheckBox IsChecked="{Binding VariantSwitch}"
                                      Command="{Binding DataContext.SubSequenceVariantSwitchCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}" />
                            <TextBlock Text=" Variant switch" VerticalAlignment="Center" />
                        </StackPanel>
                    </GroupBox>
                    <GroupBox Grid.Row="2" Header="{Binding}">
                        <GroupBox.HeaderTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Condition" Style="{StaticResource GroupBoxHeader}" />
                                    <Button HorizontalAlignment="Left"
                                        Style="{StaticResource TermDesignerButton}"
                                        ContentTemplate="{StaticResource TermDesignerButtonContent}"
                                        Command="{Binding DataContext.ShowTermDesignerCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}">
                                        <Button.Resources>
                                            <s:String x:Key="TermPropertyName">Term</s:String>
                                            <s:String x:Key="EditorMode">UseTerm</s:String>
                                            <s:String x:Key="ReturnType">System.Boolean</s:String>
                                        </Button.Resources>
                                        <Button.CommandParameter>
                                            <MultiBinding Converter="{StaticResource TermMultiValueConverter}">
                                                <Binding Source="{StaticResource TermPropertyName}" />
                                                <Binding Source="{StaticResource EditorMode}" />
                                                <Binding Source="{StaticResource ReturnType}" />
                                                <Binding Path="Term" />
                                            </MultiBinding>
                                        </Button.CommandParameter>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </GroupBox.HeaderTemplate>
                        <GroupBox.Visibility>
                            <MultiBinding Converter="{StaticResource SubSequenceConditionVisibilityConverter}">
                                <Binding Path="ExecutionType" />
                                <Binding Path="VariantSwitch" />
                            </MultiBinding>
                        </GroupBox.Visibility>
                        <Grid>
                            <uiHelpers:MTFEditor Value="{Binding Term}"
                                                 TypeName="System.Boolean" EditorMode="UseTerm"
                                                      Visibility="{Binding Term, Converter={StaticResource ShowSimpleTermVisibilityConverter}}"/>
                            <TextBlock Text="{Binding Term}" TextWrapping="Wrap"
                                           Visibility="{Binding Term, Converter={StaticResource ShowComplexTermVisibilityConverter}}"/>
                        </Grid>
                    </GroupBox>

                    <GroupBox Grid.Row="3" Header="Cases">
                        <GroupBox.Visibility>
                            <MultiBinding Converter="{StaticResource CasesVisibilityMultiConverter}">
                                <Binding Path="ExecutionType" />
                                <Binding Path="VariantSwitch" />
                                <Binding Path="Term" />
                            </MultiBinding>
                        </GroupBox.Visibility>
                        <uiHelpers:MTFEditor Value="{Binding Cases}" TypeName="{Binding CasesType}"
                                             ParentActivity="{Binding}"
                                             ParentSequence="{Binding DataContext.Sequence, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type seqEditor:SequenceEditorControl}}}"/>
                    </GroupBox>

                    <GroupBox Grid.Row="4" Header="On output value failed">
                        <StackPanel Orientation="Vertical">
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <CheckBox IsChecked="{Binding RepeatOnCheckOutputFailed}" />
                                <TextBlock Text=" Repeat" VerticalAlignment="Center" />
                            </StackPanel>
                            <StackPanel Orientation="Vertical">
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding RepeatOnCheckOutputFailed}" Value="True">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>
                                <Grid Margin="0,0,0,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Column="0" Grid.Row="0" Text="Number of repetitions: " VerticalAlignment="Center" />
                                    <uiHelpers:MTFEditor Grid.Column="1" Grid.Row="0" 
                                                         Value="{Binding NumberOfAttemptsOnCheckOutputFailed}"
                                                         TypeName="{Binding NumberTypeName}"
                                                         Margin="2"/>
                                    <TextBlock Grid.Column="0" Grid.Row="1"  Text="Delay between tries[ms]: " VerticalAlignment="Center" />
                                    <uiHelpers:MTFEditor Grid.Column="1" Grid.Row="1" 
                                                         Value="{Binding RepeatDelayOnCheckOutputFailed}"
                                                         TypeName="{Binding NumberTypeName}"
                                                         Margin="2"/>
                                </Grid>

                            </StackPanel>
                            <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource OnOutputValueFailedCombo}" />
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Grid.Row="5" Header="On Error:">
                        <StackPanel Orientation="Vertical">
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <CheckBox IsChecked="{Binding Repeat}" />
                                <TextBlock Text=" Repeat" VerticalAlignment="Center" />
                            </StackPanel>
                            <StackPanel Orientation="Vertical">
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Repeat}" Value="True">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>
                                <Grid Margin="0,0,0,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Column="0" Grid.Row="0" Text="Number of repetitions: " VerticalAlignment="Center" />
                                    <uiHelpers:MTFEditor Grid.Column="1" Grid.Row="0" 
                                                         Value="{Binding NumberOfAttempts}"
                                                         TypeName="{Binding NumberTypeName}"
                                                         Margin="2"/>
                                    <TextBlock Grid.Column="0" Grid.Row="1"  Text="Delay between tries[ms]: " VerticalAlignment="Center" />
                                    <uiHelpers:MTFEditor Grid.Column="1" Grid.Row="1" 
                                                         Value="{Binding RepeatDelay}"
                                                         TypeName="{Binding NumberTypeName}"
                                                         Margin="2"/>
                                </Grid>

                            </StackPanel>
                            <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource OnErrorFailedCombo}" />
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Append error: " Grid.Column="0" VerticalAlignment="Center" />
                                <nullableComboBox:NullableComboBox Grid.Column="1" MinWidth="50" Margin="2,2,0,0"
                                                                   DisplayMemberPath="Name"
                                                                   SelectedValue="{Binding ErrorOutput, UpdateSourceTrigger=Explicit}">
                                    <nullableComboBox:NullableComboBox.ItemsSource>
                                        <MultiBinding Converter="{StaticResource VariableByTypeConverter}">
                                            <Binding Path="DataContext.Sequence.MTFVariables"
                                                     RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}" />
                                        </MultiBinding>
                                    </nullableComboBox:NullableComboBox.ItemsSource>
                                </nullableComboBox:NullableComboBox>
                            </Grid>
                            
                            <Grid Margin="0,4,0,4">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>
                                <TextBlock Text="Call on Error: " VerticalAlignment="Top" Grid.Column="0" Grid.Row="0" />
                                <activityTargetControl:ActivityTarget Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="1" 
                                                                      MinWidth="50" Margin="2,2,0,0"
                                                                      Activity="{Binding ActivityOnCatch}" 
                                                                      ActivitiesByCall="{Binding DataContext.Sequence.ActivitiesByCall, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"
                                                                      IsComboBoxVisible="True"/>
                            </Grid>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Grid.Row="6" Header="Group activities">
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <CheckBox IsChecked="{Binding IsExecuteAsOneActivity}"/>
                            <TextBlock Text=" Execute as one activity" VerticalAlignment="Center" />
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Grid.Row="7" Header="Service">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <CheckBox IsChecked="{Binding CanExecuteService}"/>
                                <TextBlock Text=" Can execute service" VerticalAlignment="Center" />
                            </StackPanel>
                            <ContentPresenter Content="{Binding}">
                                <ContentPresenter.Style>
                                    <Style TargetType="ContentPresenter">
                                        <Setter Property="ContentTemplate" Value="{StaticResource EmptyTemplate}" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding CanExecuteService}" Value="True">
                                                <Setter Property="ContentTemplate" Value="{StaticResource ShowServiceProperty}" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ContentPresenter.Style>
                            </ContentPresenter>
                        </StackPanel>
                    </GroupBox>
                    <GroupBox Grid.Row="8" Header="Switch DUT">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0 0 0 4">
                                <CheckBox IsChecked="{Binding SwitchDUT}"/>
                                <TextBlock Text=" Switch DUT" VerticalAlignment="Center" />
                            </StackPanel>
                            <StackPanel Visibility="{Binding SwitchDUT, Converter={StaticResource BoolToVisibility}}">
                                <TextBlock Text="Switch to DUT" />
                                <ComboBox ItemsSource="{Binding DataContext.Sequence.DeviceUnderTestInfos, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"
                                          DisplayMemberPath="Name" SelectedItem="{Binding SwitchToDeviceUnderTestInfo}"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>
                    <GroupBox Grid.Row="9" Header="Comment:" BorderThickness="0">
                        <TextBox Text="{Binding Comment, UpdateSourceTrigger=PropertyChanged}" AcceptsReturn="True"
                                 TextWrapping="Wrap" MinHeight="100"
                                 VerticalContentAlignment="Top"/>
                    </GroupBox>
                </Grid>
            </ContentControl>
        </DataTemplate>
        <DataTemplate x:Key="MTFExecuteActivityDetailDataTemplate">
            <detailDataTemplates:ExecuteActivityDetail DisplayMode="{x:Static detailDataTemplates:EditorDisplayMode.Detail}" 
                                                       Presenter="{Binding DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}" />
        </DataTemplate>
        <DataTemplate x:Key="MTFLoggingActivityDetailDataTemplate">
            <ContentControl>
                <Grid>
                    <Grid.Resources>
                        <Style TargetType="GroupBox" BasedOn="{StaticResource {x:Type GroupBox}}">
                            <Setter Property="BorderThickness" Value="0" />
                            <Setter Property="Padding" Value="3" />
                        </Style>
                        <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                            <Setter Property="Margin" Value="0" />
                        </Style>
                    </Grid.Resources>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <Border Grid.Row="0" Background="{StaticResource ALYellowBrush}"
                            Height="{StaticResource ItemHeight}">
                        <TextBlock Text="Logging Detail" HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Margin="0"/>
                    </Border>

                    <StackPanel Grid.Row="1" Orientation="Vertical" Visibility="{Binding LoggingType, Converter={StaticResource loggingTypeOpenLogFileConverter}}">
                        <GroupBox Header="Type">
                            <TextBlock Text="Open log file" />
                        </GroupBox>
                        <GroupBox Header="Log file name: ">
                            <uiHelpers:MTFEditor Value="{Binding LogFileName, UpdateSourceTrigger=PropertyChanged}"
                                                    TypeName="MTFClientServerCommon.MTFStringFormat"
                                                    />
                        </GroupBox>
                    </StackPanel>
                    <StackPanel Grid.Row="1" Orientation="Vertical" Visibility="{Binding LoggingType, Converter={StaticResource loggingTypeLogMessageConverter}}">
                        <GroupBox Header="Type">
                            <StackPanel Orientation="Vertical">
                                <TextBlock Text="Log message" />
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,0" >
                                    <TextBlock Text="Log time stamp " />
                                    <uiHelpers:MTFEditor Value="{Binding LogTimeStamp, UpdateSourceTrigger=PropertyChanged}"
                                                    TypeName="System.Boolean"
                                                    />
                                </StackPanel>
                            </StackPanel>
                        </GroupBox>
                        <GroupBox Header="Message: " >
                            <uiHelpers:MTFEditor Value="{Binding LogMessage, UpdateSourceTrigger=PropertyChanged}"
                                                    TypeName="MTFClientServerCommon.MTFStringFormat"
                                                    />
                        </GroupBox>
                    </StackPanel>

                    <GroupBox Grid.Row="3" Header="Comment:" BorderThickness="0">
                        <TextBox Text="{Binding Comment, UpdateSourceTrigger=PropertyChanged}" TextWrapping="Wrap" MinHeight="100"
                                 VerticalContentAlignment="Top"  AcceptsReturn="True"/>
                    </GroupBox>
                </Grid>

            </ContentControl>
        </DataTemplate>
        <DataTemplate x:Key="MTFSequenceHandlingActivityDetailDataTemplate">
            <detailDataTemplates:SequenceHandling DataContext="{Binding}" />
        </DataTemplate>
        <DataTemplate x:Key="MTFErrorHandlingActivityDetailDataTemplate">
            <detailDataTemplates:ErrorHandling DisplayMode="{x:Static detailDataTemplates:EditorDisplayMode.Detail}" />
        </DataTemplate>
        <DataTemplate x:Key="MTFSequenceMessageActivityDetailDataTemplate">
            <detailDataTemplates:MessageActivity DisplayMode="{x:Static detailDataTemplates:EditorDisplayMode.Detail}" />
           </DataTemplate>
        <DataTemplate x:Key="MTFVariableDetailDataTemplate">
            <ContentControl>
                <Grid Grid.IsSharedSizeScope="True">
                    <Grid.Resources>
                        <Style TargetType="GroupBox" BasedOn="{StaticResource {x:Type GroupBox}}">
                            <Setter Property="BorderThickness" Value="0" />
                            <Setter Property="Padding" Value="3" />
                        </Style>
                        <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                            <Setter Property="Margin" Value="0" />
                        </Style>
                        <DataTemplate x:Key="noTableTemplate" />
                        <DataTemplate x:Key="hasTableTemplate">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" SharedSizeGroup="title"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="Validation mode: " FontWeight="Bold" Margin="0,5,5,0" VerticalAlignment="Center"/>
                                <ComboBox Grid.Column="1" VerticalAlignment="Center" Margin="0,10,5,0"
                                          ItemsSource="{Binding DataContext.ValidationTableExecutionModes, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"
                                          SelectedValuePath="Value"
                                          DisplayMemberPath="Description"
                                          SelectedValue="{Binding Value.ExecutionMode}"
                                          HorizontalAlignment="Left"/>

                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Save to log:" FontWeight="Bold" Margin="0,5,5,0" VerticalAlignment="Center" />
                                <CheckBox Grid.Row="1" Grid.Column="1" IsChecked="{Binding Value.SaveToLog}" Margin="0,5,5,0" />

                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Check multiple filling in a row:" FontWeight="Bold" Margin="0,5,5,0" VerticalAlignment="Center" />
                                <CheckBox Grid.Row="2" Grid.Column="1" IsChecked="{Binding Value.CheckMultipleFilling}" Margin="0,5,5,0" />

                                <TextBlock Grid.Row="3" Grid.Column="0" Text="Show/Hide all:" FontWeight="Bold" Margin="0,5,5,0" VerticalAlignment="Center" />
                                <CheckBox Grid.Row="3" Grid.Column="1" IsChecked="{Binding Value.HideAll}" Margin="0,5,5,0" />

                                <TextBlock Grid.Row="4" Grid.Column="0" Text="Use GS data:" FontWeight="Bold" Margin="0,5,5,0" VerticalAlignment="Center" />
                                <CheckBox Grid.Row="4" Grid.Column="1" IsChecked="{Binding Value.UseGoldSample}" Margin="0,5,5,0" />

                                <TextBlock Grid.Row="5" Grid.Column="0" Text="GS limit +/- [%]:" FontWeight="Bold" Margin="0,5,5,0" VerticalAlignment="Center"
                                           Visibility="{Binding Value.UseGoldSample, Converter={StaticResource BoolToVisibility}}"/>
                                <uiHelpers:MTFEditor Grid.Row="5" Grid.Column="1" Value="{Binding Value.GoldSampleLimit}" TypeName="System.Double" Margin="0,5,5,0"
                                                     Visibility="{Binding Value.UseGoldSample, Converter={StaticResource BoolToVisibility}}"/>
                            </Grid>
                        </DataTemplate>
                    </Grid.Resources>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" SharedSizeGroup="title"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Border Grid.Row="0" Background="{StaticResource ALYellowBrush}"
                            Grid.ColumnSpan="2" Margin="0,0,0,8"
                            Height="{StaticResource ItemHeight}">
                        <TextBlock Text="Variable Detail" HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Margin="0"/>
                    </Border>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Name: " FontWeight="Bold" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center"  />

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="TypeName: " FontWeight="Bold" Margin="0,5,5,5" VerticalAlignment="Center"/>
                    <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding TypeName}" VerticalAlignment="Center" />
                    <ComboBox Grid.Row="2" Grid.Column="1" Visibility="{Binding HasTable, Converter={StaticResource NotBoolToVisibility}}"
                              ItemsSource="{Binding DataContext.VariableTypeToChange, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}" 
                              SelectedValue="{Binding TypeName}" />

                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Init Value: " FontWeight="Bold" VerticalAlignment="Center"/>
                    <uiHelpers:MTFEditor Grid.Row="3" Grid.Column="1" 
                        VerticalAlignment="Center"                 
                        Value="{Binding Value}"
                        TypeName="{Binding TypeName}" />

                    <ContentPresenter Content="{Binding}" Grid.Row="4" Grid.ColumnSpan="2">
                        <ContentPresenter.Style>
                            <Style TargetType="ContentPresenter">
                                <Setter Property="ContentTemplate" Value="{StaticResource noTableTemplate}" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding HasValidationTable}" Value="True">
                                        <Setter Property="ContentTemplate" Value="{StaticResource hasTableTemplate}" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ContentPresenter.Style>
                    </ContentPresenter>

                    <TextBlock Grid.Row="5" Grid.Column="0" Text="Is Global: " FontWeight="Bold" Margin="0,5,5,5" VerticalAlignment="Center"/>
                    <CheckBox Grid.Row="5" Grid.Column="1" IsChecked="{Binding IsGlobal}" VerticalAlignment="Center" />

                    <TextBlock Grid.Row="6" Grid.Column="0" Text="Depends on DUT: " FontWeight="Bold" Margin="0,5,5,5" VerticalAlignment="Center"/>
                    <CheckBox Grid.Row="6" Grid.Column="1" IsChecked="{Binding DependsOnDut}" VerticalAlignment="Center" />

                    <Grid Grid.Row="7" Grid.ColumnSpan="2">
                        <Grid.Style >
                            <Style TargetType="{x:Type Grid}">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding HasValidationTable}" Value="True">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                    <!--<MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding HasValidationTable}" Value="True" />
                                            <Condition Binding="{Binding Value.RowsCount}" Value="0" />
                                        </MultiDataTrigger.Conditions>
                                        <MultiDataTrigger.Setters>
                                            <Setter Property="Visibility" Value="Visible"></Setter>
                                        </MultiDataTrigger.Setters>
                                    </MultiDataTrigger>-->
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>

                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <Grid Grid.Row="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" SharedSizeGroup="title" />
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Allow NOK GS for whole table: " FontWeight="Bold" />
                            <CheckBox Grid.Row="0" Grid.Column="1" IsChecked="{Binding Value.AllowNokGsForTable}" />
                        </Grid>

                        <Grid Grid.Row="1" Visibility="{Binding Value.AllowNokGsForTable, Converter={StaticResource BoolToVisibility}}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Border Grid.ColumnSpan="4" Background="{StaticResource ALYellowBrush}" Margin="0,10,0,5">
                                <TextBlock Text="NOK GS for table" HorizontalAlignment="Center" Margin="10"/>
                            </Border>
                            <editors:MTFVariantEditor Grid.Row="1" Grid.Column="0" Grid.RowSpan="2" Margin="0 0 0 10"
                                              Value="{Binding Value.NokVariantSelectorForTable}"
                                              IsEnabled="true"
                                              ParentSequence="{Binding DataContext.Sequence, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"/>
                        </Grid>
                    </Grid>

                    <ContentPresenter Content="{Binding}"
                                      Visibility="{Binding DataContext.SelectedInitRow, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}, Converter={StaticResource NotNullToVisibility}}"
                                      Grid.Row="8"
                                      Grid.Column="0"
                                      Grid.ColumnSpan="2"
                                      ContentTemplate="{StaticResource RowVersionDetail}"  />
                </Grid>
            </ContentControl>
        </DataTemplate>
        <DataTemplate x:Key="MTFServiceCommandDetailDataTemplate">
            <ContentControl>
                <seqEditor:ServiceCommandSettings ServiceCommand="{Binding}"
                                                  AllServiceCommands="{Binding DataContext.Sequence.ServiceCommands, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"
                                                  ServiceDesignSetting="{Binding DataContext.Sequence.ServiceDesignSetting, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}" />
            </ContentControl>
        </DataTemplate>
        <DataTemplate x:Key="MTFUserCommandDetailDataTemplate">
            <ContentControl>
                <seqEditor:UserCommandSettings UserCommand="{Binding}" 
                                               AllUserCommands="{Binding DataContext.Sequence.UserCommands, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}" />
            </ContentControl>
        </DataTemplate>
        <DataTemplate x:Key="MTFVariableActivityDetailDataTemplate">
            <ContentControl>
                <Grid>
                    <Grid.Resources>
                        <Style TargetType="GroupBox" BasedOn="{StaticResource {x:Type GroupBox}}">
                            <Setter Property="BorderThickness" Value="0" />
                            <Setter Property="Padding" Value="3" />
                        </Style>
                        <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                            <Setter Property="Margin" Value="0" />
                        </Style>
                    </Grid.Resources>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="5" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Border Grid.Row="0" Background="{StaticResource ALYellowBrush}"
                            Grid.ColumnSpan="2"
                            Margin="0,0,0,10"
                            Height="{StaticResource ItemHeight}">
                        <TextBlock Text="Set Variable Detail" HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Margin="0"/>
                    </Border>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Variable: " FontWeight="Bold" VerticalAlignment="Center"/>
                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Variable.Name}" />

                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Value: " FontWeight="Bold" Margin="0,5,5,5" VerticalAlignment="Top"/>
                    <StackPanel Orientation="Vertical" Grid.Row="3" Grid.Column="1" >
                        <uiHelpers:MTFEditor Value="{Binding Value}"
                                                 TypeName="{Binding Variable.TypeName}" EditorMode="UseTerm"
                                                 Visibility="{Binding Value, Converter={StaticResource ShowSimpleTermVisibilityConverter}}"/>
                        <TextBlock Text="{Binding Value}" TextWrapping="Wrap"
                                       Visibility="{Binding Value, Converter={StaticResource ShowComplexTermVisibilityConverter}}"/>
                        <Button HorizontalAlignment="Left"
                                        Style="{StaticResource TermDesignerButton}"
                                    ContentTemplate="{StaticResource TermDesignerButtonContent}"
                                        Command="{Binding DataContext.ShowTermDesignerCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}">
                            <Button.Resources>
                                <s:String x:Key="TermPropertyName">Value</s:String>
                                <s:String x:Key="EditorMode">UseTerm</s:String>
                            </Button.Resources>
                            <Button.CommandParameter>
                                <MultiBinding Converter="{StaticResource TermMultiValueConverter}">
                                    <Binding Source="{StaticResource TermPropertyName}" />
                                    <Binding Source="{StaticResource EditorMode}" />
                                    <Binding Path="Variable.TypeName" />
                                    <Binding Path="Value" />
                                </MultiBinding>
                            </Button.CommandParameter>
                        </Button>
                    </StackPanel>
                    <GroupBox Grid.Row="5" Grid.ColumnSpan="2" Header="Comment:" BorderThickness="0">
                        <TextBox Text="{Binding Comment, UpdateSourceTrigger=PropertyChanged}" TextWrapping="Wrap" MinHeight="100"
                                 VerticalContentAlignment="Top"  AcceptsReturn="True"/>
                    </GroupBox>
                </Grid>
            </ContentControl>
        </DataTemplate>
        <DataTemplate x:Key="MTFFillValidationTableActivityDetailDataTemplate">
            <Grid>
                <Grid.Resources>
                    <Style TargetType="GroupBox" BasedOn="{StaticResource {x:Type GroupBox}}">
                        <Setter Property="BorderThickness" Value="0" />
                        <Setter Property="Padding" Value="3" />
                    </Style>
                    <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                        <Setter Property="Margin" Value="0" />
                    </Style>
                </Grid.Resources>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <Border Grid.Row="0" Background="{StaticResource ALYellowBrush}"
                            Height="{StaticResource ItemHeight}">
                    <TextBlock Text="Fill Validation table Detail" HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Margin="0"/>
                </Border>
                <GroupBox Grid.Row="1" Header="{Binding}">
                    <GroupBox.HeaderTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Condition" Style="{StaticResource GroupBoxHeader}" />
                                <Button HorizontalAlignment="Left"
                                        Style="{StaticResource TermDesignerButton}"
                                        ContentTemplate="{StaticResource TermDesignerButtonContent}"
                                        Command="{Binding DataContext.ShowTermDesignerCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}">
                                    <Button.Resources>
                                        <s:String x:Key="TermPropertyName">Term</s:String>
                                        <s:String x:Key="EditorMode">UseTerm</s:String>
                                        <s:String x:Key="ReturnType">System.Boolean</s:String>
                                    </Button.Resources>
                                    <Button.CommandParameter>
                                        <MultiBinding Converter="{StaticResource TermMultiValueConverter}">
                                            <Binding Source="{StaticResource TermPropertyName}" />
                                            <Binding Source="{StaticResource EditorMode}" />
                                            <Binding Source="{StaticResource ReturnType}" />
                                            <Binding Path="Term" />
                                        </MultiBinding>
                                    </Button.CommandParameter>
                                </Button>
                            </StackPanel>
                        </DataTemplate>
                    </GroupBox.HeaderTemplate>
                    <Grid>
                        <uiHelpers:MTFEditor Value="{Binding Term}"
                                                 TypeName="System.Boolean" EditorMode="UseTerm"
                                                      Visibility="{Binding Term, Converter={StaticResource ShowSimpleTermVisibilityConverter}}"/>
                        <TextBlock Text="{Binding Term}" TextWrapping="Wrap"
                                           Visibility="{Binding Term, Converter={StaticResource ShowComplexTermVisibilityConverter}}"/>
                    </Grid>
                </GroupBox>
                <GroupBox Grid.Row="2" Header="On output value failed">
                    <StackPanel Orientation="Vertical">
                        <StackPanel Orientation="Vertical">
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <CheckBox IsChecked="{Binding RepeatOnCheckOutputFailed}" />
                                <TextBlock Text=" Repeat" VerticalAlignment="Center" />
                            </StackPanel>
                            <StackPanel Orientation="Vertical">
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding RepeatOnCheckOutputFailed}" Value="True">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>
                                <Grid Margin="0,0,0,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Column="0" Grid.Row="0" Text="Number of repetitions: " VerticalAlignment="Center" />
                                    <uiHelpers:MTFEditor Grid.Column="1" Grid.Row="0" 
                                                         Value="{Binding NumberOfAttemptsOnCheckOutputFailed}"
                                                         TypeName="{Binding NumberTypeName}"
                                                         Margin="2"/>
                                    <TextBlock Grid.Column="0" Grid.Row="1"  Text="Delay between tries[ms]: " VerticalAlignment="Center" />
                                    <uiHelpers:MTFEditor Grid.Column="1" Grid.Row="1" 
                                                         Value="{Binding RepeatDelayOnCheckOutputFailed}"
                                                         TypeName="{Binding NumberTypeName}"
                                                         Margin="2"/>
                                </Grid>

                            </StackPanel>
                            <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource OnOutputValueFailedCombo}" />
                        </StackPanel>
                    </StackPanel>
                </GroupBox>
                <GroupBox Grid.Row="4" Header="Comment:" BorderThickness="0">
                    <TextBox Text="{Binding Comment, UpdateSourceTrigger=PropertyChanged}" AcceptsReturn="True"
                                 TextWrapping="Wrap" MinHeight="100"
                                 VerticalContentAlignment="Top"/>
                </GroupBox>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="SearchResultMethodDetailDataTemplate" />
        <DataTemplate x:Key="SearchResultDetailDataTemplate" />



        <DataTemplate x:Key="SelectedActivity">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfActivityName" MinWidth="100"/>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfClassAlias" MinWidth="100"/>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfMethodName" MinWidth="100"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <localizedString:LocalizedStringEditor Grid.Column="0" Style="{StaticResource ActivityNameEditor}" />
                <Label Grid.Column="1" Content="{Binding ClassInfo.Alias}" Style="{StaticResource SelectedStringLabel}"/>
                <ComboBox Grid.Column="2"
                                  ItemsSource="{Binding ClassInfo.MTFClass.AllExecutables}"
                                  DisplayMemberPath="DisplayName"
                                  SelectedValuePath="Name"
                                  SelectedItem="{Binding DataContext.SelectedClassExecutable, RelativeSource={RelativeSource FindAncestor,AncestorType={x:Type UserControl}}}"
                                  SelectedValue="{Binding MTFMethodName, UpdateSourceTrigger=Explicit}"
                                Style="{StaticResource ActivityComboBox}"/>
                <TextBlock Grid.Column="3" Style="{StaticResource ActivityCommentTextBlock}"/>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="UnselectedActivity">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfActivityName" MinWidth="100"/>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfClassAlias" MinWidth="100"/>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfMethodName" MinWidth="100"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Label Grid.Column="0" Content="{Binding}" Style="{StaticResource UnSelectedActivityLabel}"/>
                <Label Grid.Column="1" Content="{Binding ClassInfo.Alias}" Style="{StaticResource UnSelectedStringLabel}"/>
                <Label Grid.Column="2" Content="{Binding MTFMethodDisplayName}" Style="{StaticResource LabelInsteadComboBox}"/>
                <TextBlock Grid.Column="3" Style="{StaticResource ActivityCommentTextBlock}"/>
            </Grid>
        </DataTemplate>
        <DataTemplate DataType="{x:Type mtfClientServerCommon:MTFSequenceActivity}">
            <Grid Style="{StaticResource ActivityGrid}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="40" />
                    <ColumnDefinition Width="30" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="30" />
                </Grid.ColumnDefinitions>
                <ContentPresenter Grid.Column="0" Content="{Binding}" ContentTemplate="{StaticResource ActivityIcon}" />
                <CheckBox Grid.Column="1" Style="{StaticResource SelectedActivityCheckBox}" />
                <ContentPresenter Grid.Column="2" Content="{Binding}">
                    <ContentPresenter.Style>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="ContentTemplate" Value="{StaticResource UnselectedActivity}" />
                            <Style.Triggers>
                                <DataTrigger Value="True">
                                    <DataTrigger.Binding>
                                        <MultiBinding Converter="{StaticResource IsActivitySelected}">
                                            <Binding />
                                            <Binding Path="DataContext.SelectionHelper.Selection" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}" />
                                            <Binding Path="Refresh" />
                                        </MultiBinding>
                                    </DataTrigger.Binding>
                                    <Setter Property="ContentTemplate" Value="{StaticResource SelectedActivity}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ContentPresenter.Style>
                </ContentPresenter>
                <Button Grid.Column="3" Style="{StaticResource SelectedActivityRemoveButton}" />
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="SelectedSubSequence">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfActivityName" MinWidth="100"/>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfClassAlias" MinWidth="100" />
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <localizedString:LocalizedStringEditor Grid.Column="0" Style="{StaticResource ActivityNameEditor}" />
                <ComboBox Grid.Column="1" Name="errorBehavioursCombo"
                                ItemsSource="{Binding DataContext.ExecutionTypes, RelativeSource={RelativeSource FindAncestor,AncestorType={x:Type UserControl}}}"
                                SelectedValuePath="Value"
                                DisplayMemberPath="Description"
                                SelectedValue="{Binding ExecutionType}"
                                SelectionChanged="executionType_SelectionChanged"
                                Style="{StaticResource ActivityComboBox}"/>
                <TextBlock Grid.Column="2" Style="{StaticResource ActivityCommentTextBlock}"/>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="UnselectedSubSequence">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfActivityName" MinWidth="100"/>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfClassAlias" MinWidth="100" />
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Label Grid.Column="0" Content="{Binding}" Style="{StaticResource SelectedActivityLabel}"/>
                <Label Grid.Column="1" Content="{Binding ExecutionType, Converter={StaticResource EnumToDescription}}"
                       Style="{StaticResource LabelInsteadComboBox}" BorderBrush="{StaticResource ALBlackBrush}"/>
                <TextBlock Grid.Column="2" Style="{StaticResource ActivityCommentTextBlock}"/>
            </Grid>
        </DataTemplate>

        <Style TargetType="ListBox" x:Key="ActivityListBoxStyle">
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Grid.IsSharedSizeScope" Value="True" />
            <Setter Property="SelectionMode" Value="Extended" />
            <Setter Property="AllowDrop" Value="True" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="ScrollViewer.CanContentScroll" Value="False" />
            <Setter Property="FocusVisualStyle" Value="{x:Null}" />
            <Setter Property="Template" Value="{StaticResource ListBoxControlTemplate}" />
            <Setter Property="ItemContainerStyle" Value="{StaticResource ActivityListBoxItem}" />
            <EventSetter Event="PreviewDragOver" Handler="ActivityListBoxDragOver" />
            <EventSetter Event="Drop" Handler="ActivityListBoxDrop" />
            <EventSetter Event="PreviewMouseLeftButtonDown" Handler="ActivityListBoxPreviewMouseLeftButtonDown" />
            <EventSetter Event="PreviewMouseLeftButtonUp" Handler="ActivityListBoxPreviewMouseLeftButtonUp" />

        </Style>
        <DataTemplate x:Key="SubSequenceList">
            <seqEditor:MTFListBox Style="{StaticResource ActivityListBoxStyle}"
                                Margin="50,0,0,0"
                                ItemsSource="{Binding Activities, IsAsync=True}"
                                 PreviewMouseWheel="ScrollParentListBox" 
                                SelectedItem="{Binding DataContext.LastSelectedItem, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type seqEditor:SequenceEditorControl}}}"
                                SequenceEditor="{Binding DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type seqEditor:SequenceEditorControl}}}">
            </seqEditor:MTFListBox>
        </DataTemplate>

        <ContextMenu x:Key="TabItemContextMenu">
            <MenuItem Command="{Binding DataContext.RemoveCaseCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"
                                  CommandParameter="{Binding}">
                <MenuItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <UserControl HorizontalAlignment="Right" VerticalAlignment="Top" MaxWidth="30" MaxHeight="30"
                                                                    Style="{StaticResource IconTrash}"
                                                                    Margin="0,0,10,0"/>
                            <TextBlock Text="Delete" VerticalAlignment="Center" />
                        </StackPanel>
                    </DataTemplate>
                </MenuItem.HeaderTemplate>
            </MenuItem>
        </ContextMenu>

        <Style x:Key="TabItemHeader" TargetType="{x:Type TabItem}" BasedOn="{StaticResource CaseTabItem}">
            <Setter Property="ContextMenu" Value="{StaticResource TabItemContextMenu}" />
            <Setter Property="Header" Value="{Binding Name}" />
        </Style>

        <DataTemplate x:Key="SubSequenceCase">
            <TabControl ItemsSource="{Binding Cases}" BorderThickness="0" SelectedIndex="{Binding ActualCaseIndex}" MaxWidth="1200"
                        HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch"
                        ItemContainerStyle="{StaticResource TabItemHeader}">
                <TabControl.ContentTemplate>
                    <DataTemplate>
                        <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource SubSequenceList}" />
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>
        </DataTemplate>
        <DataTemplate x:Key="SubSequenceContent">
            <ContentPresenter Content="{Binding}">
                <ContentPresenter.Style>
                    <Style TargetType="ContentPresenter">
                        <Setter Property="ContentTemplate" Value="{StaticResource SubSequenceList}" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding ExecutionType}" Value="ExecuteByCase">
                                <Setter Property="ContentTemplate" Value="{StaticResource SubSequenceCase}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ContentPresenter.Style>
            </ContentPresenter>
        </DataTemplate>
        <DataTemplate DataType="{x:Type mtfClientServerCommon:MTFSubSequenceActivity}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <Grid Grid.Row="0" Style="{StaticResource SubSequenceGrid}" >
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="40" />
                        <ColumnDefinition Width="30" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="30" />
                    </Grid.ColumnDefinitions>
                    <Button Style="{StaticResource CollapsedButton}" Foreground="{StaticResource ALBlackBrush}" HorizontalAlignment="Center"
                            Command="{Binding DataContext.ChangeCollapsedStateCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"/>
                    <CheckBox Grid.Column="1" Style="{StaticResource SelectedActivityCheckBox}" />
                    <ContentPresenter Grid.Column="2" Content="{Binding}">
                        <ContentPresenter.Style>
                            <Style TargetType="ContentPresenter">
                                <Setter Property="ContentTemplate" Value="{StaticResource UnselectedSubSequence}" />
                                <Style.Triggers>
                                    <DataTrigger Value="True">
                                        <DataTrigger.Binding>
                                            <MultiBinding Converter="{StaticResource IsActivitySelected}">
                                                <Binding />
                                                <Binding Path="DataContext.SelectionHelper.Selection" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}" />
                                                <Binding Path="Refresh" />
                                            </MultiBinding>
                                        </DataTrigger.Binding>
                                        <Setter Property="ContentTemplate" Value="{StaticResource SelectedSubSequence}" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ContentPresenter.Style>
                    </ContentPresenter>
                    <Button Grid.Column="3" Style="{StaticResource SelectedActivityRemoveButton}" />
                </Grid>
                <ContentPresenter Grid.Row="1" Content="{Binding}" IsEnabled="{Binding IsActive}" >
                    <ContentPresenter.Style>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="ContentTemplate" Value="{StaticResource EmptyTemplate}" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsCollapsed}" Value="False">
                                    <Setter Property="ContentTemplate" Value="{StaticResource SubSequenceContent}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ContentPresenter.Style>
                </ContentPresenter>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="SelectedExecuteActivity">
            <detailDataTemplates:ExecuteActivityDetail DisplayMode="{x:Static detailDataTemplates:EditorDisplayMode.Selected}" />
        </DataTemplate>
        <DataTemplate x:Key="UnselectedExecuteActivity">
            <detailDataTemplates:ExecuteActivityDetail DisplayMode="{x:Static detailDataTemplates:EditorDisplayMode.Unselected}" />
        </DataTemplate>
        <DataTemplate DataType="{x:Type mtfClientServerCommon:MTFExecuteActivity}">
            <Grid Style="{StaticResource ActivityGrid}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="40" />
                    <ColumnDefinition Width="30" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="30" />
                </Grid.ColumnDefinitions>
                <ContentPresenter Grid.Column="0" Content="{Binding}" ContentTemplate="{StaticResource ActivityIcon}" />
                <CheckBox Grid.Column="1" Style="{StaticResource SelectedActivityCheckBox}" />
                <ContentPresenter Grid.Column="2" Content="{Binding}">
                    <ContentPresenter.Style>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="ContentTemplate" Value="{StaticResource UnselectedExecuteActivity}" />
                            <Style.Triggers>
                                <DataTrigger Value="True">
                                    <DataTrigger.Binding>
                                        <MultiBinding Converter="{StaticResource IsActivitySelected}">
                                            <Binding />
                                            <Binding Path="DataContext.SelectionHelper.Selection" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}" />
                                            <Binding Path="Refresh" />
                                        </MultiBinding>
                                    </DataTrigger.Binding>
                                    <Setter Property="ContentTemplate" Value="{StaticResource SelectedExecuteActivity}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ContentPresenter.Style>
                </ContentPresenter>
                <Button Grid.Column="3" Style="{StaticResource SelectedActivityRemoveButton}" />
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="SelectedSequenceHandlingActivity">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfActivityName" MinWidth="100"/>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfClassAlias" MinWidth="100" />
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <localizedString:LocalizedStringEditor Grid.Column="0" Style="{StaticResource ActivityNameEditor}" />
                <alControls:ComboBox Grid.Column="1" Name="errorBehavioursCombo"
                                  ItemsSourceLocalized="{Binding DataContext.SequenceHandlingTypes, RelativeSource={RelativeSource FindAncestor,AncestorType={x:Type UserControl}}}"
                                  SelectedValuePath="Value"
                                  LocTextKey="Description"
                                  SelectedValue="{Binding SequenceHandlingType}"
                          Style="{StaticResource ActivityComboBox}"/>
                <TextBlock Grid.Column="2" Style="{StaticResource ActivityCommentTextBlock}"/>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="UnselectedSequenceHandlingActivity">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfActivityName" MinWidth="100"/>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfClassAlias" MinWidth="100" />
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Label Grid.Column="0" Content="{Binding}" Style="{StaticResource UnSelectedActivityLabel}"/>
                <Label Grid.Column="1" Content="{Binding SequenceHandlingType, Converter={StaticResource EnumToDescription}}" Style="{StaticResource LabelInsteadComboBox}"/>
                <TextBlock Grid.Column="2" Style="{StaticResource ActivityCommentTextBlock}"/>
            </Grid>
        </DataTemplate>
        <DataTemplate DataType="{x:Type mtfClientServerCommon:MTFSequenceHandlingActivity}">
            <Grid Style="{StaticResource ActivityGrid}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="40" />
                    <ColumnDefinition Width="30" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="30" />
                </Grid.ColumnDefinitions>
                <ContentPresenter Grid.Column="0" Content="{Binding}" ContentTemplate="{StaticResource ActivityIcon}" />
                <CheckBox Grid.Column="1" Style="{StaticResource SelectedActivityCheckBox}" />
                <ContentPresenter Grid.Column="2" Content="{Binding}">
                    <ContentPresenter.Style>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="ContentTemplate" Value="{StaticResource UnselectedSequenceHandlingActivity}" />
                            <Style.Triggers>
                                <DataTrigger Value="True">
                                    <DataTrigger.Binding>
                                        <MultiBinding Converter="{StaticResource IsActivitySelected}">
                                            <Binding />
                                            <Binding Path="DataContext.SelectionHelper.Selection" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}" />
                                            <Binding Path="Refresh" />
                                        </MultiBinding>
                                    </DataTrigger.Binding>
                                    <Setter Property="ContentTemplate" Value="{StaticResource SelectedSequenceHandlingActivity}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ContentPresenter.Style>
                </ContentPresenter>
                <Button Grid.Column="3" Style="{StaticResource SelectedActivityRemoveButton}" />
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="SelectedErrorHandlingActivity">
            <detailDataTemplates:ErrorHandling DisplayMode="{x:Static detailDataTemplates:EditorDisplayMode.Selected}" />
        </DataTemplate>
        <DataTemplate x:Key="UnselectedErrorHandlingActivity">
            <detailDataTemplates:ErrorHandling DisplayMode="{x:Static detailDataTemplates:EditorDisplayMode.Unselected}" />
        </DataTemplate>
        <DataTemplate DataType="{x:Type mtfClientServerCommon:MTFErrorHandlingActivity}">
            <Grid Style="{StaticResource ActivityGrid}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="40" />
                    <ColumnDefinition Width="30" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="30" />
                </Grid.ColumnDefinitions>
                <ContentPresenter Grid.Column="0" Content="{Binding}" ContentTemplate="{StaticResource ActivityIcon}" />
                <CheckBox Grid.Column="1" Style="{StaticResource SelectedActivityCheckBox}" />
                <ContentPresenter Grid.Column="2" Content="{Binding}">
                    <ContentPresenter.Style>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="ContentTemplate" Value="{StaticResource UnselectedErrorHandlingActivity}" />
                            <Style.Triggers>
                                <DataTrigger Value="True">
                                    <DataTrigger.Binding>
                                        <MultiBinding Converter="{StaticResource IsActivitySelected}">
                                            <Binding />
                                            <Binding Path="DataContext.SelectionHelper.Selection" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}" />
                                            <Binding Path="Refresh" />
                                        </MultiBinding>
                                    </DataTrigger.Binding>
                                    <Setter Property="ContentTemplate" Value="{StaticResource SelectedErrorHandlingActivity}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ContentPresenter.Style>
                </ContentPresenter>
                <Button Grid.Column="3" Style="{StaticResource SelectedActivityRemoveButton}" />
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="SelectedMessageActivity">
            <detailDataTemplates:MessageActivity DisplayMode="{x:Static detailDataTemplates:EditorDisplayMode.Selected}" />
        </DataTemplate>
        <DataTemplate x:Key="UnselectedMessageActivity">
            <detailDataTemplates:MessageActivity DisplayMode="{x:Static detailDataTemplates:EditorDisplayMode.Unselected}" />
        </DataTemplate>
        <DataTemplate DataType="{x:Type mtfClientServerCommon:MTFSequenceMessageActivity}">
            <Grid Style="{StaticResource ActivityGrid}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="40" />
                    <ColumnDefinition Width="30" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="30" />
                </Grid.ColumnDefinitions>
                <ContentPresenter Grid.Column="0" Content="{Binding}" ContentTemplate="{StaticResource ActivityIcon}" />
                <CheckBox Grid.Column="1" Style="{StaticResource SelectedActivityCheckBox}" />
                <ContentPresenter Grid.Column="2" Content="{Binding}">
                    <ContentPresenter.Style>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="ContentTemplate" Value="{StaticResource UnselectedMessageActivity}" />
                            <Style.Triggers>
                                <DataTrigger Value="True">
                                    <DataTrigger.Binding>
                                        <MultiBinding Converter="{StaticResource IsActivitySelected}">
                                            <Binding />
                                            <Binding Path="DataContext.SelectionHelper.Selection" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}" />
                                            <Binding Path="Refresh" />
                                        </MultiBinding>
                                    </DataTrigger.Binding>
                                    <Setter Property="ContentTemplate" Value="{StaticResource SelectedMessageActivity}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ContentPresenter.Style>
                </ContentPresenter>
                <Button Grid.Column="3" Style="{StaticResource SelectedActivityRemoveButton}" />
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="SelectedVariableActivity">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfActivityName" MinWidth="100"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <localizedString:LocalizedStringEditor Grid.Column="0" Style="{StaticResource ActivityNameEditor}" />
                <TextBlock Grid.Column="1" Style="{StaticResource ActivityCommentTextBlock}"/>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="UnselectedVariableActivity">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfActivityName" MinWidth="100"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Label Grid.Column="0" Content="{Binding}" Style="{StaticResource UnSelectedActivityLabel}"/>
                <TextBlock Grid.Column="1" Style="{StaticResource ActivityCommentTextBlock}"/>
            </Grid>
        </DataTemplate>
        <DataTemplate DataType="{x:Type mtfClientServerCommon:MTFVariableActivity}">
            <Grid Style="{StaticResource ActivityGrid}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="40" />
                    <ColumnDefinition Width="30" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="30" />
                </Grid.ColumnDefinitions>
                <ContentPresenter Grid.Column="0" Content="{Binding}" ContentTemplate="{StaticResource ActivityIcon}" />
                <CheckBox Grid.Column="1" Style="{StaticResource SelectedActivityCheckBox}" />
                <ContentPresenter Grid.Column="2" Content="{Binding}">
                    <ContentPresenter.Style>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="ContentTemplate" Value="{StaticResource UnselectedVariableActivity}" />
                            <Style.Triggers>
                                <DataTrigger Value="True">
                                    <DataTrigger.Binding>
                                        <MultiBinding Converter="{StaticResource IsActivitySelected}">
                                            <Binding />
                                            <Binding Path="DataContext.SelectionHelper.Selection" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}" />
                                            <Binding Path="Refresh" />
                                        </MultiBinding>
                                    </DataTrigger.Binding>
                                    <Setter Property="ContentTemplate" Value="{StaticResource SelectedVariableActivity}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ContentPresenter.Style>
                </ContentPresenter>
                <Button Grid.Column="3" Style="{StaticResource SelectedActivityRemoveButton}" />
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="SelectedFillValidationTableActivity">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfActivityName" MinWidth="100"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <localizedString:LocalizedStringEditor Grid.Column="0" Style="{StaticResource ActivityNameEditor}" />
                <TextBlock Grid.Column="1" Style="{StaticResource ActivityCommentTextBlock}"/>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="UnselectedFillValidationTableActivity">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="mtfActivityName" MinWidth="100"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Label Grid.Column="0" Content="{Binding}" Style="{StaticResource UnSelectedActivityLabel}"/>
                <TextBlock Grid.Column="1" Style="{StaticResource ActivityCommentTextBlock}"/>
            </Grid>
        </DataTemplate>
        <DataTemplate DataType="{x:Type mtfClientServerCommon:MTFFillValidationTableActivity}">
            <Grid Style="{StaticResource ActivityGrid}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="40" />
                    <ColumnDefinition Width="30" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="30" />
                </Grid.ColumnDefinitions>
                <ContentPresenter Grid.Column="0" Content="{Binding}" ContentTemplate="{StaticResource ActivityIcon}" />
                <CheckBox Grid.Column="1" Style="{StaticResource SelectedActivityCheckBox}" />
                <ContentPresenter Grid.Column="2" Content="{Binding}">
                    <ContentPresenter.Style>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="ContentTemplate" Value="{StaticResource UnselectedFillValidationTableActivity}" />
                            <Style.Triggers>
                                <DataTrigger Value="True">
                                    <DataTrigger.Binding>
                                        <MultiBinding Converter="{StaticResource IsActivitySelected}">
                                            <Binding />
                                            <Binding Path="DataContext.SelectionHelper.Selection" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}" />
                                            <Binding Path="Refresh" />
                                        </MultiBinding>
                                    </DataTrigger.Binding>
                                    <Setter Property="ContentTemplate" Value="{StaticResource SelectedFillValidationTableActivity}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ContentPresenter.Style>
                </ContentPresenter>
                <Button Grid.Column="3" Style="{StaticResource SelectedActivityRemoveButton}" />
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="SequenceSetting">
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                <StackPanel Orientation="Vertical" Grid.IsSharedSizeScope="True">
                    <settings:VersionSettingsControl Margin="10" DataContext="{Binding Sequence}" />
                    <settings:ServiceSetting Margin="10" ServiceDesignSetting="{Binding Sequence.ServiceDesignSetting}" />
                    <settings:RoundingRulesSettings Margin="10" DataContext="{Binding}" />
                    <settings:ExternalSequenceSettings Margin="10" Sequence="{Binding Sequence}" IsOpen="{Binding IsSettingsOpened}"  />
                    <settings:GoldSampleSettings Margin="10" Setting="{Binding Sequence.GoldSampleSetting}" />
                    <settings:SequenceVariantsSettings Margin="10" Sequence="{Binding Sequence}" />
                    <settings:DeviceUnderTestSettings Margin="10" Sequence="{Binding Sequence}" />
                    <settings:ClientUISetting Margin="10" Sequence="{Binding Sequence}" IsOpen="{Binding IsSettingsOpened}" />
                </StackPanel>
            </ScrollViewer>
        </DataTemplate>

        <DataTemplate x:Key="TermDesignerTemplate">
            <Border BorderThickness="1,1,3,0" BorderBrush="{StaticResource ALBlackBrush}">
                <editors:MTFTermDesigner Value="{Binding SelectedTerm}" SelectedActivity="{Binding LastSelectedItem}"
                                          TermPropertyName="{Binding TermPropertyName}" ParentOfTerm="{Binding ParentOfTerm}"
                                         IsOpen="{Binding ShowTermDesigner}" EditorMode="{Binding EditorMode}" TargetType="{Binding SelectedTermTargetType}"/>
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="GraphicalView">
            <graphicalView:GraphicalViewControl Sequence="{Binding Sequence}" />
        </DataTemplate>


    </UserControl.Resources>
    <Grid Name="MainGrid" IsEnabled="{Binding AllowEditSequence}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <ContentPresenter Content="{Binding}" Grid.Row="1" Visibility="{Binding IsDifferentControlOpened, Converter={StaticResource BoolToVisibility}}">
            <ContentPresenter.Style>
                <Style TargetType="ContentPresenter">
                    <Setter Property="ContentTemplate" Value="{StaticResource EmptyTemplate}" />
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding EditorViewMode}" Value="{x:Static seqEditor:EditorViewMode.Setting}">
                            <Setter Property="ContentTemplate" Value="{StaticResource SequenceSetting}" />
                        </DataTrigger>
                        <DataTrigger Binding="{Binding EditorViewMode}" Value="{x:Static seqEditor:EditorViewMode.GraphicalView}">
                            <Setter Property="ContentTemplate" Value="{StaticResource GraphicalView}" />
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </ContentPresenter.Style>
        </ContentPresenter>
        <Grid Name="SequenceEditorGrid" Grid.Row="1" Visibility="{Binding IsDifferentControlOpened, Converter={StaticResource NotBoolToVisibility}}"
              Loaded="GridOnLoaded">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MinWidth="170" />
                <ColumnDefinition Width="200" MinWidth="170" />
            </Grid.ColumnDefinitions>

            <TabControl Grid.Column="0" ItemsSource="{Binding MTFProject}" Name="TabControlSequence"
                        SelectedItem="{Binding Sequence}" Padding="0" BorderThickness="0,2,0,0" BorderBrush="{StaticResource ALYellowBrush}">
                <TabControl.Template>
                    <ControlTemplate TargetType="{x:Type TabControl}">
                        <Grid KeyboardNavigation.TabNavigation="Local"
                      SnapsToDevicePixels="true"
                      ClipToBounds="true">
                            <!--<Grid.ColumnDefinitions>
                                <ColumnDefinition x:Name="ColumnDefinition0"/>
                                <ColumnDefinition x:Name="ColumnDefinition1"
                                          Width="100"/>
                            </Grid.ColumnDefinitions>-->
                            <Grid.RowDefinitions>
                                <RowDefinition x:Name="RowDefinition0"
                                       Height="Auto"/>
                                <RowDefinition x:Name="RowDefinition1"
                                       Height="*"/>
                            </Grid.RowDefinitions>
                            <TabPanel x:Name="HeaderPanel"
                              Panel.ZIndex ="1" 
                              KeyboardNavigation.TabIndex="1"
                              Grid.Column="0"
                              Grid.Row="0"
                              Margin="1,1,1,0"
                              IsItemsHost="true"/>
                            <Border x:Name="ContentPanel"
                            Background="{TemplateBinding Background}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            KeyboardNavigation.TabNavigation="Local"
                            KeyboardNavigation.DirectionalNavigation="Contained"
                            KeyboardNavigation.TabIndex="2"
                            Grid.Column="0"
                            Grid.Row="1"
                            Grid.ColumnSpan="2">
                                <ContentPresenter x:Name="PART_SelectedContentHost"
                                          SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"
                                          Margin="{TemplateBinding Padding}"
                                          ContentSource="SelectedContent"/>
                            </Border>
                        </Grid>
                    </ControlTemplate>
                </TabControl.Template>
                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" Margin="0">
                            <TextBlock Text="{Binding Name}" VerticalAlignment="Center" Margin="0,0,3,0" MinWidth="40"/>
                            <UserControl Style="{StaticResource IconPencil}"
                                         Visibility="{Binding IsModified, Converter={StaticResource BoolToVisibility}}"
                                         Height="12"/>
                            <Button Style="{StaticResource RemoveButton}" Foreground="{StaticResource ALBlackBrush}"
                                    Margin="2,0,0,0"
                                    Command="{Binding DataContext.RemoveExternalSubSequenceCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}"
                                    CommandParameter="{Binding}">
                                <Button.Visibility>
                                    <MultiBinding Converter="{StaticResource compareObjectsVisibilityConverter}">
                                        <Binding Path="DataContext.MainSequence" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}" />
                                        <Binding />
                                    </MultiBinding>
                                </Button.Visibility>
                            </Button>
                        </StackPanel>
                    </DataTemplate>
                </TabControl.ItemTemplate>
                <TabControl.ContentTemplate>
                    <DataTemplate>
                        <Grid Name="currentSequenceGrid" Loaded="GridOnLoaded"
                              DataContext="{Binding DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="200" MinWidth="150" />
                                <ColumnDefinition Width="*" MinWidth="150" />
                            </Grid.ColumnDefinitions>
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <ListBox        Grid.Row="0"
                                ItemsSource="{Binding BuildInCommands}"
                                PreviewMouseLeftButtonDown="CommandsListBox_PreviewMouseLeftButtonDown"
                                PreviewMouseLeftButtonUp="CommandsListBox_PreviewMouseLeftButtonUp"
                                PreviewMouseMove="CommandsListBox_PreviewMouseMove"
                                KeyDown="CommandListBox_KeyDown"
                                HorizontalContentAlignment="Stretch"
                                ItemContainerStyle="{StaticResource NoSelectionListBoxItem}"
                                Margin="3,3,5,0"
                            Template="{StaticResource ListBoxControlTemplate}">
                                    <ListBox.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="Find usages" Command="{Binding CreateFindUsagesCommand}"
                                                      CommandParameter="{Binding PlacementTarget.SelectedItem, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ContextMenu}}}" />
                                        </ContextMenu>
                                    </ListBox.ContextMenu>
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border Style="{StaticResource EditorLeftPanelItemBorder}">
                                                <alControls:TextBlock LocTextKey="{Binding Description}" HorizontalAlignment="Center"
                                                           VerticalAlignment="Center" Style="{StaticResource {x:Type TextBlock}}" />
                                            </Border>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                                <Grid Grid.Row="1" >
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="1*" />
                                        <ColumnDefinition Width="1*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition />
                                        <RowDefinition />
                                    </Grid.RowDefinitions>
                                    <ToggleButton Grid.Column="0" Content="Components" IsChecked="{Binding IsComponentActive}" />
                                    <ToggleButton Grid.Column="1" Content="Variables" IsChecked="{Binding IsVariableActive}" />
                                    <ToggleButton Grid.Row="1" Grid.Column="0" Content="Service commands" IsChecked="{Binding IsServiceCommandsActive}" />
                                    <ToggleButton Grid.Row="1" Grid.Column="1" Content="User commands" IsChecked="{Binding IsUserCommandsActive}" />
                                </Grid>
                                <ContentControl Grid.Row="2" Margin="3,2,5,0" FocusVisualStyle="{x:Null}">
                                    <ContentControl.Style>
                                        <Style TargetType="ContentControl">
                                            <Setter Property="ContentTemplate" Value="{StaticResource componentsTemplate}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsComponentActive}" Value="True">
                                                    <Setter Property="ContentTemplate" Value="{StaticResource componentsTemplate}" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding IsVariableActive}" Value="True">
                                                    <Setter Property="ContentTemplate" Value="{StaticResource variablesTemplate}" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding IsServiceCommandsActive}" Value="True">
                                                    <Setter Property="ContentTemplate" Value="{StaticResource serviceCommandsTemplate}" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding IsUserCommandsActive}" Value="True">
                                                    <Setter Property="ContentTemplate" Value="{StaticResource userCommandsTemplate}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ContentControl.Style>
                                </ContentControl>
                                <!--<CheckBox Grid.Row="3" Content=" Parameter editor is collapsed" Margin="5" IsChecked="{Binding MtfEditorIsCollapsed}" />-->
                            </Grid>
                            <GridSplitter DragCompleted="GridSplitterDragCompleted" />


                            <Grid Grid.Column="1" Name="SequenceGrid" Loaded="GridOnLoaded">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*" />
                                    <RowDefinition Height="100" MaxHeight="{Binding ElementName=currentSequenceGrid, Path=ActualHeight}" />
                                </Grid.RowDefinitions>
                                <DockPanel Grid.Row="0">
                                    <TextBlock
                                            Text="You can copy item by CTRL+C / CTRL + V or you can use right mouse button"
                                            Foreground="{StaticResource ALSilverBrush}"
                                            HorizontalAlignment="Center" Background="Transparent"
                                            VerticalAlignment="Bottom"
                                            DockPanel.Dock="Bottom" />
                                    <seqEditor:MTFListBox Name="MainListBox"
                                                              Padding="0,2,4,2"
                                                              ItemsSource="{Binding Sequence.MTFSequenceActivities, IsAsync=True}"
                                                              SelectedItem="{Binding LastSelectedItem}"
                                                              PreviewMouseRightButtonDown="ActivityListBoxPreviewMouseRightButtonDown"
                                                              PreviewMouseMove="ActivityListBoxPreviewMouseMove"
                                                              KeyDown="ActivityListBoxOnKeyDown"
                                                              SequenceEditor="{Binding DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type seqEditor:SequenceEditorControl}}}">
                                        <seqEditor:MTFListBox.Style>
                                            <Style TargetType="seqEditor:MTFListBox"
                                                       BasedOn="{StaticResource ActivityListBoxStyle}">
                                                <Setter Property="ContextMenu"
                                                            Value="{StaticResource MainListBoxContextMenu}" />
                                            </Style>
                                        </seqEditor:MTFListBox.Style>
                                    </seqEditor:MTFListBox>
                                </DockPanel>
                                <seqEditor:MTFListBox Name="CallListBox"
                                                      Grid.Row="1" MinHeight="100" 
                                                 Padding="0,2,4,2"
                                                 PreviewDragOver="CallListBoxDragOver"
                                                 ItemsSource="{Binding Sequence.ActivitiesByCall, IsAsync=True}"
                                                 SelectedItem="{Binding LastSelectedItem}"
                                                 PreviewMouseRightButtonDown="ActivityListBoxPreviewMouseRightButtonDown"
                                                 PreviewMouseMove="ActivityListBoxPreviewMouseMove"
                                                 KeyDown="ActivityListBoxOnKeyDown"
                                                 SequenceEditor="{Binding DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type seqEditor:SequenceEditorControl}}}">
                                    <seqEditor:MTFListBox.Style>
                                        <Style TargetType="seqEditor:MTFListBox" BasedOn="{StaticResource ActivityListBoxStyle}">
                                            <Setter Property="ContextMenu" Value="{StaticResource MainListBoxContextMenu}" />
                                        </Style>
                                    </seqEditor:MTFListBox.Style>
                                </seqEditor:MTFListBox>
                                <GridSplitter Grid.Row="1" Style="{StaticResource HorizontalGridSplitter}" DragCompleted="GridSplitterDragCompleted"
                                              />
                            </Grid>
                        </Grid>
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>
            <GridSplitter Grid.Column="1" DragCompleted="GridSplitterDragCompleted" HorizontalAlignment="Left" />

            <ContentPresenter Content="{Binding}" Grid.Column="0" >
                <ContentPresenter.Style>
                    <Style TargetType="ContentPresenter">
                        <Setter Property="ContentTemplate" Value="{StaticResource EmptyTemplate}" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding EditorIsVisible}" Value="False">
                                <Setter Property="ContentTemplate" Value="{StaticResource TermDesignerTemplate}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ContentPresenter.Style>
            </ContentPresenter>

            <ScrollViewer Grid.Column="1" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto" HorizontalAlignment="Stretch"
                          Padding="3,3,1,3" Margin="0,0,2,0">
                <ContentControl x:Name="sequenceDetailInfo" Background="{StaticResource ALLightSilverBrush}"
                        ContentTemplateSelector="{StaticResource detailObjectInfoSelector}"
                        Content="{Binding LastSelectedItem}">
                </ContentControl>
            </ScrollViewer>
        </Grid>
    </Grid>
</uiHelpers:MTFUserControl>
